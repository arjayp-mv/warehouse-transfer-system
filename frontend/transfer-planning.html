<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transfer Planning - Warehouse Transfer Tool</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/colreorder/1.7.0/css/colReorder.dataTables.min.css" rel="stylesheet">
    
    <style>
        /* Priority color coding */
        .priority-critical {
            background-color: #dc3545 !important;
            color: white !important;
            font-weight: bold;
        }
        .priority-high {
            background-color: #fd7e14 !important;
            color: white !important;
            font-weight: bold;
        }
        .priority-medium {
            background-color: #ffc107 !important;
            color: black !important;
        }
        .priority-low {
            background-color: #28a745 !important;
            color: white !important;
        }
        
        /* Stockout indicators */
        .stockout-badge {
            background-color: #6f42c1;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        /* Custom table styling */
        .table th {
            background-color: #f8f9fa;
            border-top: 2px solid #dee2e6;
            font-weight: 600;
            font-size: 0.85rem;
        }

        /* Sticky table headers - Excel freeze row functionality */
        #recommendations-table thead {
            position: sticky;
            top: 0;
            z-index: 100;
            background-color: #f8f9fa;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #recommendations-table thead th {
            border-bottom: 2px solid #dee2e6;
        }

        /* Table wrapper with proper height and scrolling */
        .table-responsive {
            max-height: calc(100vh - 420px);
            overflow-y: auto;
            position: relative;
        }
        
        .editable-qty {
            width: 80px;
            padding: 4px 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            text-align: center;
        }
        
        .editable-qty:focus {
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
            outline: 0;
        }

        /* Confirmed quantity styling */
        .confirmed-qty {
            background-color: #d4edda;
            color: #155724;
            font-weight: bold;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            padding: 4px 8px;
            text-align: center;
            position: relative;
        }

        .confirmed-qty.has-variance {
            background-color: #fff3cd;
            color: #856404;
            border-color: #ffeaa7;
        }

        .confirmed-qty.major-variance {
            background-color: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }

        .lock-icon {
            color: #28a745;
            margin-left: 4px;
            font-size: 0.8em;
        }

        .lock-btn {
            background: none;
            border: none;
            color: #6c757d;
            font-size: 0.9em;
            cursor: pointer;
            margin-left: 4px;
        }

        .lock-btn:hover {
            color: #28a745;
        }

        .lock-btn.locked {
            color: #28a745;
        }

        .variance-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 0.7em;
            background-color: #ffc107;
            color: #000;
            padding: 1px 4px;
            border-radius: 2px;
        }

        .variance-badge.major {
            background-color: #dc3545;
            color: white;
        }
        
        /* Loading states */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
        }
        
        /* Action buttons */
        .action-btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .btn-sm {
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
        }
        
        /* Custom filters */
        .filters-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        /* Summary stats */
        .summary-card {
            border: none;
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
        }
        
        .summary-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .summary-label {
            font-size: 0.85rem;
            opacity: 0.9;
        }
        
        /* SKU Modal Enhancements */
        .reason-wrap {
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: break-word;
            max-width: 200px;
        }

        .modal-xl .modal-body {
            padding: 1.5rem;
        }

        .pending-inventory-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .pending-item {
            background-color: white;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-left: 4px solid #007bff;
        }

        .pending-item.estimated {
            border-left-color: #ffc107;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 1rem 0;
            background-color: #ffffff;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .export-buttons {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #dee2e6;
        }

        .basic-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .info-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid #e9ecef;
        }

        .info-card h6 {
            color: #495057;
            margin-bottom: 0.75rem;
            font-weight: 600;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .action-btn-group {
                justify-content: center;
            }

            .table-responsive {
                font-size: 0.85rem;
            }

            .editable-qty {
                width: 60px;
            }

            .chart-container {
                height: 250px;
            }

            .basic-info-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="bg-light">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h5>Loading Transfer Recommendations...</h5>
            <p class="text-muted mb-3">Analyzing stockout data and calculating optimal quantities</p>

            <!-- Progress Bar -->
            <div class="progress mb-2" style="width: 300px; display: none;" id="loading-progress-container">
                <div class="progress-bar progress-bar-striped progress-bar-animated"
                     role="progressbar"
                     id="loading-progress-bar"
                     style="width: 0%"
                     aria-valuenow="0"
                     aria-valuemin="0"
                     aria-valuemax="100">
                </div>
            </div>
            <small class="text-muted" id="loading-progress-text" style="display: none;"></small>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <div class="d-flex align-items-center">
                <a href="index.html" class="btn btn-outline-light me-3">
                    <i class="fas fa-arrow-left"></i> Dashboard
                </a>
                <span class="navbar-brand mb-0 h1">
                    <i class="fas fa-truck me-2"></i>Transfer Planning
                </span>
            </div>
            <div class="d-flex align-items-center">
                <!-- Navigation Links -->
                <a href="data-management.html" class="btn btn-outline-light btn-sm me-2">
                    <i class="fas fa-database me-1"></i>Data Management
                </a>
                <a href="stockout-management.html" class="btn btn-outline-light btn-sm me-2">
                    <i class="fas fa-exclamation-triangle me-1"></i>Stockout Management
                </a>
                <a href="sku-listing.html" class="btn btn-outline-light btn-sm me-2">
                    <i class="fas fa-list me-1"></i>SKU Listing
                </a>

                <!-- Export Buttons -->
                <button class="btn btn-success btn-sm me-2" onclick="exportTransferOrderExcel()">
                    <i class="fas fa-file-excel me-1"></i>Export Transfer Order (Excel)
                </button>
                <button class="btn btn-info btn-sm me-2" onclick="exportTransferOrder()">
                    <i class="fas fa-file-csv me-1"></i>Export Transfer Order (CSV)
                </button>
                <button class="btn btn-warning btn-sm me-2" onclick="showExportAllModal()">
                    <i class="fas fa-database me-1"></i>Export All SKUs
                </button>

                <!-- Filter Button -->
                <button class="btn btn-outline-light btn-sm me-2" onclick="showSkuFilterModal()">
                    <i class="fas fa-filter me-1"></i>Filter SKUs
                </button>

                <!-- Refresh Button -->
                <button class="btn btn-outline-light btn-sm" onclick="refreshRecommendations()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card summary-card">
                    <div class="card-body text-center">
                        <div id="total-recommendations" class="summary-value">--</div>
                        <div class="summary-label">Total Recommendations</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white">
                    <div class="card-body text-center">
                        <div id="critical-count" class="summary-value">--</div>
                        <div class="summary-label">Critical Priority</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <div id="total-transfer-qty" class="summary-value">--</div>
                        <div class="summary-label">Total Transfer Qty</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body text-center">
                        <div id="avg-coverage" class="summary-value">--</div>
                        <div class="summary-label">Avg Coverage (Months)</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cache Management Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-info">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-database me-2"></i>Weighted Demand Cache Management
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center mb-2">
                                    <span class="me-3">
                                        <strong>Cache Status:</strong>
                                        <span id="cache-status" class="badge bg-secondary">Loading...</span>
                                    </span>
                                    <span class="me-3">
                                        <strong>Last Updated:</strong>
                                        <span id="cache-last-updated" class="text-muted">--</span>
                                    </span>
                                </div>
                                <div class="small text-muted">
                                    Cache contains stockout corrections, seasonal adjustments, and volatility analysis for fast page loads.
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <button class="btn btn-warning btn-sm me-2" onclick="refreshCache()" id="refresh-cache-btn">
                                    <i class="fas fa-sync me-1"></i>Refresh Cache
                                </button>
                                <button class="btn btn-outline-info btn-sm" onclick="checkCacheStatus()">
                                    <i class="fas fa-info-circle me-1"></i>Check Status
                                </button>
                            </div>
                        </div>

                        <!-- Progress bar for cache refresh -->
                        <div class="mt-3" id="cache-refresh-progress" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <small class="text-muted">Refreshing weighted demand calculations...</small>
                                <small class="text-muted" id="cache-progress-text">0%</small>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated"
                                     role="progressbar" style="width: 0%" id="cache-progress-bar"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="filters-section">
            <h6 class="mb-3"><i class="fas fa-filter me-2"></i>Filters & Actions</h6>
            <div class="row align-items-end mb-3">
                <div class="col-md-2">
                    <label class="form-label">Priority</label>
                    <select id="priority-filter" class="form-select form-select-sm">
                        <option value="">All Priorities</option>
                        <option value="CRITICAL">Critical</option>
                        <option value="HIGH">High</option>
                        <option value="MEDIUM">Medium</option>
                        <option value="LOW">Low</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">ABC Class</label>
                    <select id="abc-filter" class="form-select form-select-sm">
                        <option value="">All Classes</option>
                        <option value="A">A Items</option>
                        <option value="B">B Items</option>
                        <option value="C">C Items</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Supplier</label>
                    <select id="supplier-filter" class="form-select form-select-sm">
                        <option value="">All Suppliers</option>
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Min Transfer Qty</label>
                    <input type="number" id="min-qty-filter" class="form-control form-control-sm" placeholder="0" min="0">
                </div>
                <div class="col-md-4">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="show-recommendations-only">
                        <label class="form-check-label" for="show-recommendations-only">
                            Show only SKUs with recommendations
                        </label>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <div class="action-btn-group">
                        <button class="btn btn-primary btn-sm" onclick="applyFilters()">
                            <i class="fas fa-search"></i> Apply Filters
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="clearFilters()">
                            <i class="fas fa-times"></i> Clear
                        </button>
                        <button class="btn btn-outline-warning btn-sm" onclick="selectHighPriority()">
                            <i class="fas fa-exclamation-triangle"></i> Select High Priority
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="bulkEditSelected()">
                            <i class="fas fa-edit"></i> Bulk Edit
                        </button>
                        <button class="btn btn-success btn-sm" onclick="exportConfirmedOnly()">
                            <i class="fas fa-lock"></i> Export Confirmed Only
                        </button>
                        <button class="btn btn-outline-warning btn-sm" onclick="clearAllConfirmations()">
                            <i class="fas fa-unlock"></i> Clear All Confirmations
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="reviewVariances()">
                            <i class="fas fa-exclamation-triangle"></i> Review Variances
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transfer Recommendations Table -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i>Transfer Recommendations
                    <small class="text-muted" id="last-updated">Last updated: Loading...</small>
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table id="recommendations-table" class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="select-all"></th>
                                <th>SKU</th>
                                <th>Description</th>
                                <th>Priority</th>
                                <th>Current KY</th>
                                <th>Available CA</th>
                                <th>Burnaby Pending</th>
                                <th>Kentucky Pending</th>
                                <th>KY Monthly Demand</th>
                                <th>CA Monthly Demand</th>
                                <th>Coverage</th>
                                <th>Transfer Qty</th>
                                <th>Confirmed Qty</th>
                                <th>CA Coverage After</th>
                                <th>KY Coverage After</th>
                                <th>ABC/XYZ</th>
                                <th>Reason</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="text-center text-secondary py-4 mt-4">
            <small>Transfer recommendations based on stockout-corrected demand | Generated: <span id="generation-time">--</span></small>
        </footer>
    </div>

    <!-- SKU Detail Modal -->
    <div class="modal fade" id="sku-detail-modal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">SKU Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="sku-detail-content">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SKU Filter Modal -->
    <div class="modal fade" id="sku-filter-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Filter SKUs</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-3">
                        Enter SKU IDs to filter the table. You can paste a list of SKUs separated by commas, newlines, or spaces.
                    </p>
                    <div class="mb-3">
                        <label for="sku-filter-input" class="form-label">SKU List:</label>
                        <textarea
                            id="sku-filter-input"
                            class="form-control"
                            rows="8"
                            placeholder="Example:
WF-UKF8001
UB-YTX14-BS
SK-ABC123, SK-DEF456
SK-GHI789 SK-JKL012"></textarea>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted" id="filter-status">No filter applied</small>
                        <div>
                            <button type="button" class="btn btn-outline-secondary me-2" onclick="clearSkuFilter()">
                                Clear Filter
                            </button>
                            <button type="button" class="btn btn-primary" onclick="applySkuFilter()">
                                Apply Filter
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/colreorder/1.7.0/js/dataTables.colReorder.min.js"></script>
    <!-- Chart.js for sales visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <script>
        // Global variables
        let recommendationsData = [];
        let dataTable;
        let confirmationsData = {}; // Cache for confirmation data

        // Initialize when DOM is ready
        $(document).ready(function() {
            initializeTable();
            loadRecommendations();
        });

        /**
         * Initialize the transfer recommendations DataTable
         *
         * Sets up column ordering, search functionality, and responsive display
         * Configures special handling for action columns and numeric data
         *
         * @function initializeTable
         * @returns {void}
         */
        function initializeTable() {
            dataTable = $('#recommendations-table').DataTable({
                "pageLength": 25,
                "order": [[3, "asc"]], // Sort by priority
                "colReorder": true, // Enable column reordering
                "stateSave": true,  // Save column order and other table state
                "columnDefs": [
                    { "orderable": false, "targets": [0, 17] }, // Checkbox and actions
                    { "searchable": false, "targets": [0, 17] },
                    { "className": "text-center", "targets": [0, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13] }
                ],
                "dom": '<"row"<"col-sm-6"l><"col-sm-6"f>>rtip',
                "language": {
                    "search": "Search SKUs:",
                    "lengthMenu": "Show _MENU_ recommendations",
                    "info": "Showing _START_ to _END_ of _TOTAL_ recommendations"
                }
            });
        }

        /**
         * Load transfer recommendations from the backend API
         *
         * Fetches all transfer recommendations with stockout-corrected calculations,
         * updates summary statistics, and populates the DataTable
         *
         * @async
         * @function loadRecommendations
         * @returns {Promise<void>}
         * @throws {Error} Shows alert if API call fails
         */
        async function loadRecommendations() {
            showLoading(true);
            recommendationsData = [];

            try {
                // Phase 1: Load high-priority items first (100 items)
                updateProgress(true, 10, 'Loading urgent items...');
                await loadRecommendationChunk(true, 1, 100, 'Loading urgent items...');

                // Update UI with priority items
                updateSummaryStats();
                populateSupplierFilter();
                populateTable();
                updateProgress(true, 25, 'Urgent items loaded');

                // Phase 2: Load remaining items in chunks
                let page = 1;
                let hasMore = true;
                let loadedNonPriority = 0;
                let estimatedTotal = 4000; // Estimate for progress calculation

                while (hasMore && loadedNonPriority < 4000) { // Safety limit
                    const chunkData = await loadRecommendationChunk(false, page, 200,
                        `Loading remaining items... (${loadedNonPriority} loaded)`);

                    if (chunkData.pagination && chunkData.pagination.total_count) {
                        estimatedTotal = chunkData.pagination.total_count;
                    }

                    if (chunkData.pagination.has_next) {
                        page++;
                        loadedNonPriority += chunkData.recommendations.length;

                        // Calculate progress (25% for priority items + 75% for remaining)
                        const remainingProgress = (loadedNonPriority / estimatedTotal) * 75;
                        const totalProgress = Math.min(25 + remainingProgress, 95);

                        updateProgress(true, totalProgress,
                            `${loadedNonPriority + 100} of ${estimatedTotal} items loaded`);

                        // Update UI progressively
                        updateSummaryStats();
                        populateTable();
                    } else {
                        hasMore = false;
                    }

                    // Small delay to prevent UI blocking
                    await new Promise(resolve => setTimeout(resolve, 50));
                }

                updateProgress(true, 100, 'Loading complete');
                updateTimestamp(new Date().toISOString());

                // Brief delay to show completion
                await new Promise(resolve => setTimeout(resolve, 300));

            } catch (error) {
                console.error('Error loading recommendations:', error);
                showError('Failed to load transfer recommendations. Please check your connection.');
            } finally {
                updateProgress(false);
                showLoading(false);
            }
        }

        /**
         * Update loading overlay text without hiding/showing it
         * @param {string} message - Status message to display
         */
        function updateLoadingText(message) {
            const overlay = document.getElementById('loading-overlay');
            const messageEl = overlay.querySelector('p');
            if (messageEl) {
                messageEl.textContent = message;
            }
        }

        /**
         * Show/hide and update progress bar
         * @param {boolean} show - Whether to show the progress bar
         * @param {number} [percentage=0] - Progress percentage (0-100)
         * @param {string} [text=''] - Progress text to display
         */
        function updateProgress(show, percentage = 0, text = '') {
            const container = document.getElementById('loading-progress-container');
            const bar = document.getElementById('loading-progress-bar');
            const textEl = document.getElementById('loading-progress-text');

            if (show) {
                container.style.display = 'block';
                textEl.style.display = 'block';

                bar.style.width = `${percentage}%`;
                bar.setAttribute('aria-valuenow', percentage);

                if (text) {
                    textEl.textContent = text;
                }
            } else {
                container.style.display = 'none';
                textEl.style.display = 'none';
            }
        }

        /**
         * Load a specific chunk of recommendations
         * @param {boolean} priorityFirst - Load priority items first
         * @param {number} page - Page number
         * @param {number} pageSize - Items per page
         * @param {string} statusText - Status message to display
         * @returns {Promise<Object>} Response data with pagination info
         */
        async function loadRecommendationChunk(priorityFirst, page, pageSize, statusText) {
            updateLoadingText(statusText);

            const params = new URLSearchParams({
                priority_first: priorityFirst,
                page: page,
                page_size: pageSize
            });

            const response = await fetch(`/api/transfer-recommendations?${params}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            // Append new recommendations to existing data
            recommendationsData = recommendationsData.concat(data.recommendations || []);

            return data;
        }

        /**
         * Update dashboard summary statistics
         *
         * Calculates and displays total SKUs, high priority items,
         * total transfer quantity, and average coverage metrics
         *
         * @function updateSummaryStats
         * @returns {void}
         */
        function updateSummaryStats() {
            const total = recommendationsData.length;
            const critical = recommendationsData.filter(r => r.priority === 'CRITICAL').length;
            const totalQty = recommendationsData.reduce((sum, r) => sum + r.recommended_transfer_qty, 0);
            const avgCoverage = recommendationsData.reduce((sum, r) => sum + (r.coverage_months || 0), 0) / total;
            
            document.getElementById('total-recommendations').textContent = total;
            document.getElementById('critical-count').textContent = critical;
            document.getElementById('total-transfer-qty').textContent = totalQty.toLocaleString();
            document.getElementById('avg-coverage').textContent = avgCoverage ? avgCoverage.toFixed(1) : '0.0';
        }

        /**
         * Populate supplier filter dropdown with unique suppliers from data
         *
         * Extracts unique supplier values from recommendations data and populates
         * the supplier filter dropdown for user selection
         *
         * @function populateSupplierFilter
         * @returns {void}
         */
        function populateSupplierFilter() {
            const supplierFilter = document.getElementById('supplier-filter');
            const suppliers = [...new Set(recommendationsData
                .map(rec => rec.supplier)
                .filter(supplier => supplier && supplier.trim() !== '')
            )].sort();

            // Clear existing options except "All Suppliers"
            supplierFilter.innerHTML = '<option value="">All Suppliers</option>';

            // Add unique suppliers
            suppliers.forEach(supplier => {
                const option = document.createElement('option');
                option.value = supplier;
                option.textContent = supplier;
                supplierFilter.appendChild(option);
            });
        }

        /**
         * Update a single row in the DataTable without clearing filters
         *
         * @function updateSingleRow
         * @param {Object} rec - Transfer recommendation data for the row to update
         * @returns {void}
         */
        function updateSingleRow(rec) {
            // Find the row with matching SKU
            const rowNode = dataTable.rows().nodes().toArray().find(node => {
                return $(node).data('sku') === rec.sku_id;
            });

            if (rowNode) {
                // Get the row API object
                const row = dataTable.row(rowNode);

                // Create new row HTML
                const newRowHtml = createTableRow(rec);
                const $newRow = $(newRowHtml);

                // Remove old row and add new one through DataTables API
                // This ensures DataTables internal cache is updated properly
                row.remove();
                dataTable.row.add($newRow[0]);

                // Redraw only the specific page without clearing filters
                dataTable.draw(false);
            }
        }

        /**
         * Populate DataTable with filtered transfer recommendations
         *
         * Clears existing data and populates table with current recommendationsData,
         * applying any active filters and updating row display
         *
         * @function populateTable
         * @returns {void}
         */
        function populateTable() {
            dataTable.clear();

            recommendationsData.forEach(rec => {
                const row = createTableRow(rec);
                dataTable.row.add($(row));
            });

            dataTable.draw();
        }

        /**
         * Create HTML table row for a transfer recommendation
         *
         * Generates complete table row with priority styling, editable quantities,
         * coverage indicators, and action buttons
         *
         * @function createTableRow
         * @param {Object} rec - Transfer recommendation data
         * @param {string} rec.sku_id - SKU identifier
         * @param {string} rec.priority - Priority level (CRITICAL, HIGH, MEDIUM, LOW)
         * @param {number} rec.recommended_transfer_qty - Calculated transfer quantity
         * @param {number} rec.coverage_months - Months of coverage after transfer
         * @returns {string} HTML table row string
         */
        function createTableRow(rec) {
            const priorityClass = `priority-${rec.priority.toLowerCase()}`;
            // Create warehouse-specific stockout badges
            const burnbyBadge = rec.burnaby_stockout_days > 0 ? `<span class="stockout-badge">CA:${rec.burnaby_stockout_days}d</span>` : '';
            const kentuckyBadge = rec.kentucky_stockout_days > 0 ? `<span class="stockout-badge">US:${rec.kentucky_stockout_days}d</span>` : '';
            const stockoutBadge = burnbyBadge + (burnbyBadge && kentuckyBadge ? ' ' : '') + kentuckyBadge;
            const coverageColor = rec.coverage_months < 1 ? 'text-danger' : rec.coverage_months < 2 ? 'text-warning' : 'text-success';
            
            return `
                <tr data-sku="${rec.sku_id}">
                    <td><input type="checkbox" class="row-select" value="${rec.sku_id}"></td>
                    <td><strong>${rec.sku_id}</strong></td>
                    <td>
                        <span class="text-truncate d-inline-block" style="max-width: 200px;" title="${rec.description}">
                            ${rec.description}
                        </span>
                    </td>
                    <td><span class="badge ${priorityClass}">${rec.priority}</span></td>
                    <td>${rec.current_kentucky_qty}</td>
                    <td>${rec.current_burnaby_qty}</td>
                    <td>
                        ${rec.burnaby_pending || 0}
                        ${rec.days_until_arrival ? `<small class="text-muted">(${rec.days_until_arrival}d)</small>` : ''}
                    </td>
                    <td>
                        ${rec.kentucky_pending || 0}
                        ${rec.days_until_arrival ? `<small class="text-muted">(${rec.days_until_arrival}d)</small>` : ''}
                    </td>
                    <td>
                        <strong>${rec.corrected_monthly_demand.toFixed(0)}</strong>
                        <small class="text-muted">(${(rec.kentucky_6month_supply || rec.corrected_monthly_demand * 6).toFixed(0)} for 6mo)</small>
                        ${stockoutBadge}
                    </td>
                    <td>
                        <strong>${(rec.burnaby_monthly_demand || 0).toFixed(0)}</strong>
                        <small class="text-muted">(${(rec.burnaby_6month_supply || 0)} for 6mo)</small>
                    </td>
                    <td><span class="${coverageColor}">${rec.coverage_months.toFixed(1)}m</span></td>
                    <td>
                        <input type="number"
                               class="editable-qty"
                               value="${rec.recommended_transfer_qty}"
                               min="0"
                               step="${rec.transfer_multiple}"
                               data-sku="${rec.sku_id}"
                               onchange="updateTransferQty('${rec.sku_id}', this.value)">
                    </td>
                    <td>
                        ${createConfirmedQtyColumn(rec)}
                    </td>
                    <td>
                        <span class="text-success">${(rec.burnaby_coverage_after_transfer || 0).toFixed(1)}m</span>
                        ${rec.burnaby_retention_warning ? '<i class="fas fa-exclamation-triangle text-warning ms-1" title="Below minimum retention"></i>' : ''}
                    </td>
                    <td>
                        <span class="text-info">${(rec.kentucky_coverage_after_transfer || 0).toFixed(1)}m</span>
                    </td>
                    <td>${rec.abc_class}${rec.xyz_class}</td>
                    <td>
                        <div class="reason-wrap" title="${rec.reason}">
                            ${rec.reason}
                        </div>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="showSkuDetails('${rec.sku_id}')">
                            <i class="fas fa-info-circle"></i>
                        </button>
                    </td>
                </tr>
            `;
        }

        /**
         * Create the confirmed quantity column HTML
         *
         * @function createConfirmedQtyColumn
         * @param {Object} rec - Transfer recommendation data
         * @returns {string} HTML for confirmed quantity column
         */
        function createConfirmedQtyColumn(rec) {
            const isConfirmed = rec.is_confirmed;
            const confirmedQty = rec.confirmed_qty || 0;
            const hasVariance = rec.has_significant_variance;
            const hasMajorVariance = rec.has_major_variance;
            const variancePercent = rec.variance_percent || 0;

            if (isConfirmed) {
                let classes = 'confirmed-qty';
                if (hasMajorVariance) {
                    classes += ' major-variance';
                } else if (hasVariance) {
                    classes += ' has-variance';
                }

                let varianceBadge = '';
                if (hasMajorVariance) {
                    varianceBadge = `<span class="variance-badge major" title="Major variance: ${variancePercent}%">${variancePercent}%</span>`;
                } else if (hasVariance) {
                    varianceBadge = `<span class="variance-badge" title="Variance: ${variancePercent}%">${variancePercent}%</span>`;
                }

                return `
                    <div class="${classes}" title="Confirmed by ${rec.confirmed_by || 'system'} on ${rec.confirmed_at || ''}">
                        ${confirmedQty}
                        <i class="fas fa-lock lock-icon"></i>
                        ${varianceBadge}
                        <button class="lock-btn locked" onclick="unlockTransferQty('${rec.sku_id}')" title="Unlock quantity">
                            <i class="fas fa-unlock"></i>
                        </button>
                    </div>
                `;
            } else {
                // When unlocked, show an editable input field for flexible quantity entry
                return `
                    <div class="d-flex align-items-center">
                        <input type="number"
                               id="confirm-qty-${rec.sku_id}"
                               class="form-control form-control-sm me-2"
                               value="${rec.recommended_transfer_qty}"
                               min="0"
                               style="width: 80px;"
                               placeholder="Qty">
                        <button class="lock-btn" onclick="confirmTransferQtyFromInput('${rec.sku_id}')" title="Lock this quantity">
                            <i class="fas fa-lock"></i>
                        </button>
                    </div>
                `;
            }
        }

        /**
         * Confirm transfer quantity from the input field
         *
         * @function confirmTransferQtyFromInput
         * @param {string} skuId - SKU identifier
         * @returns {Promise<void>}
         */
        async function confirmTransferQtyFromInput(skuId) {
            const inputEl = document.getElementById(`confirm-qty-${skuId}`);
            if (!inputEl) {
                alert('Unable to find quantity input field');
                return;
            }

            const qty = parseInt(inputEl.value);
            if (isNaN(qty) || qty < 0) {
                alert('Please enter a valid quantity (0 or higher)');
                inputEl.focus();
                return;
            }

            await confirmTransferQty(skuId, qty);
        }

        /**
         * Confirm/lock a transfer quantity for a specific SKU
         *
         * @function confirmTransferQty
         * @param {string} skuId - SKU identifier
         * @param {number} qty - Quantity to confirm
         * @param {string} notes - Optional notes
         * @returns {Promise<void>}
         */
        async function confirmTransferQty(skuId, qty, notes = '') {
            try {
                const rec = recommendationsData.find(r => r.sku_id === skuId);
                if (!rec) {
                    alert('SKU not found in recommendations');
                    return;
                }

                const confirmationData = {
                    confirmed_qty: parseInt(qty),
                    original_suggested_qty: rec.recommended_transfer_qty,
                    confirmed_by: 'user', // Could be made dynamic
                    notes: notes
                };

                const response = await fetch(`/api/transfer-confirmations/${skuId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(confirmationData)
                });

                if (!response.ok) {
                    throw new Error(`Failed to confirm quantity: ${response.statusText}`);
                }

                const result = await response.json();

                // Update local data
                rec.confirmed_qty = confirmationData.confirmed_qty;
                rec.original_suggested_qty = confirmationData.original_suggested_qty;
                rec.confirmed_by = confirmationData.confirmed_by;
                rec.confirmed_at = new Date().toISOString();
                rec.is_confirmed = true;
                rec.variance_percent = result.confirmation.variance_percent || 0;
                rec.has_significant_variance = Math.abs(rec.variance_percent) > 20;
                rec.has_major_variance = Math.abs(rec.variance_percent) > 50;

                // Update only the specific row instead of refreshing entire table
                updateSingleRow(rec);

                console.log(`Confirmed transfer quantity for ${skuId}: ${qty}`);

            } catch (error) {
                console.error('Failed to confirm transfer quantity:', error);
                alert(`Failed to confirm quantity: ${error.message}`);
            }
        }

        /**
         * Unlock a confirmed transfer quantity
         *
         * @function unlockTransferQty
         * @param {string} skuId - SKU identifier to unlock
         * @returns {Promise<void>}
         */
        async function unlockTransferQty(skuId) {
            if (!confirm(`Are you sure you want to unlock the confirmed quantity for ${skuId}?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/transfer-confirmations/${skuId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error(`Failed to unlock quantity: ${response.statusText}`);
                }

                // Update local data
                const rec = recommendationsData.find(r => r.sku_id === skuId);
                if (rec) {
                    rec.confirmed_qty = null;
                    rec.original_suggested_qty = null;
                    rec.confirmed_by = null;
                    rec.confirmed_at = null;
                    rec.is_confirmed = false;
                    rec.variance_percent = 0;
                    rec.has_significant_variance = false;
                    rec.has_major_variance = false;
                }

                // Update only the specific row instead of refreshing entire table
                updateSingleRow(rec);

                console.log(`Unlocked transfer quantity for ${skuId}`);

            } catch (error) {
                console.error('Failed to unlock transfer quantity:', error);
                alert(`Failed to unlock quantity: ${error.message}`);
            }
        }

        /**
         * Clear all transfer confirmations
         *
         * @function clearAllConfirmations
         * @returns {Promise<void>}
         */
        async function clearAllConfirmations() {
            const confirmedCount = recommendationsData.filter(r => r.is_confirmed).length;

            if (confirmedCount === 0) {
                alert('No confirmed quantities to clear.');
                return;
            }

            if (!confirm(`Are you sure you want to clear all ${confirmedCount} confirmed quantities? This action cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch('/api/transfer-confirmations', {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error(`Failed to clear confirmations: ${response.statusText}`);
                }

                // Update local data
                recommendationsData.forEach(rec => {
                    rec.confirmed_qty = null;
                    rec.original_suggested_qty = null;
                    rec.confirmed_by = null;
                    rec.confirmed_at = null;
                    rec.is_confirmed = false;
                    rec.variance_percent = 0;
                    rec.has_significant_variance = false;
                    rec.has_major_variance = false;
                });

                // Refresh the table
                populateTable();

                alert(`Cleared ${confirmedCount} confirmed quantities.`);

            } catch (error) {
                console.error('Failed to clear confirmations:', error);
                alert(`Failed to clear confirmations: ${error.message}`);
            }
        }

        /**
         * Export only confirmed transfer quantities
         *
         * @function exportConfirmedOnly
         * @returns {Promise<void>}
         */
        async function exportConfirmedOnly() {
            const confirmedItems = recommendationsData.filter(r => r.is_confirmed && r.confirmed_qty > 0);

            if (confirmedItems.length === 0) {
                alert('No confirmed quantities to export.');
                return;
            }

            try {
                const response = await fetch('/api/export/confirmed-transfers');

                if (!response.ok) {
                    throw new Error(`Export failed: ${response.statusText}`);
                }

                // Get filename from response headers
                const contentDisposition = response.headers.get('content-disposition');
                const filename = contentDisposition
                    ? contentDisposition.split('filename=')[1].replace(/"/g, '')
                    : `confirmed-transfers-${new Date().toISOString().split('T')[0]}.csv`;

                // Download the file
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                alert(`Exported ${confirmedItems.length} confirmed transfers: ${filename}`);

            } catch (error) {
                console.error('Failed to export confirmed transfers:', error);
                alert(`Export failed: ${error.message}`);
            }
        }

        /**
         * Review items with significant variances
         *
         * @function reviewVariances
         * @returns {void}
         */
        function reviewVariances() {
            const varianceItems = recommendationsData.filter(r => r.is_confirmed && r.has_significant_variance);

            if (varianceItems.length === 0) {
                alert('No confirmed quantities with significant variances found.');
                return;
            }

            // Apply filter to show only variance items
            dataTable.clear();
            varianceItems.forEach(rec => {
                const row = createTableRow(rec);
                dataTable.row.add($(row));
            });
            dataTable.draw();

            alert(`Showing ${varianceItems.length} items with significant variances (>20% difference from suggested quantity).`);
        }

        /**
         * Update transfer quantity for a specific SKU
         *
         * Validates and updates the recommended transfer quantity,
         * ensuring proper rounding to transfer multiples
         *
         * @function updateTransferQty
         * @param {string} skuId - SKU identifier to update
         * @param {string|number} newQty - New transfer quantity (will be parsed to integer)
         * @returns {void}
         */
        function updateTransferQty(skuId, newQty) {
            const qty = parseInt(newQty);
            if (isNaN(qty) || qty < 0) {
                alert('Please enter a valid quantity (0 or higher)');
                return;
            }
            
            // Find and update the recommendation
            const rec = recommendationsData.find(r => r.sku_id === skuId);
            if (rec) {
                rec.recommended_transfer_qty = qty;
                updateSummaryStats();
                console.log(`Updated ${skuId} transfer qty to ${qty}`);
            }
        }

        /**
         * Show detailed SKU information in modal dialog
         *
         * Fetches complete SKU data including sales history, pending inventory,
         * and displays in enhanced modal with charts and export options
         *
         * @async
         * @function showSkuDetails
         * @param {string} skuId - SKU identifier to display details for
         * @returns {Promise<void>}
         * @throws {Error} Shows alert if SKU data cannot be loaded
         */
        async function showSkuDetails(skuId) {
            const modal = new bootstrap.Modal(document.getElementById('sku-detail-modal'));
            
            // Set loading state
            document.getElementById('sku-detail-content').innerHTML = `
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading SKU details...</p>
                </div>
            `;
            
            modal.show();
            
            try {
                const response = await fetch(`/api/sku/${skuId}`);
                if (!response.ok) throw new Error('Failed to load SKU details');
                
                const skuData = await response.json();
                displaySkuDetails(skuData);
                
            } catch (error) {
                document.getElementById('sku-detail-content').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Failed to load SKU details: ${error.message}
                    </div>
                `;
            }
        }

        /**
         * Display enhanced SKU details in modal with comprehensive information
         *
         * Features:
         * - 3-column responsive grid layout
         * - Pending inventory with days until arrival calculations
         * - Sales history with total column
         * - Interactive Chart.js visualization with stockout indicators
         * - CSV export functionality for individual SKU
         *
         * @param {Object} skuData - Complete SKU data from API response
         * @param {Object} skuData.sku - SKU master data (ID, description, ABC/XYZ codes)
         * @param {Array<Object>} skuData.sales_history - Monthly sales data for both warehouses
         * @param {Array<Object>} skuData.pending_inventory - Pending orders with arrival dates
         */
        function displaySkuDetails(skuData) {
            // Calculate total sales for each month
            const salesWithTotals = skuData.sales_history.map(s => ({
                ...s,
                total_sales: (s.burnaby_sales || 0) + (s.kentucky_sales || 0)
            }));

            // Calculate pending inventory arrival days
            const pendingWithDays = skuData.pending_inventory.map(p => {
                if (p.expected_arrival) {
                    const expectedDate = new Date(p.expected_arrival);
                    const today = new Date();
                    const diffTime = expectedDate - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    return { ...p, days_until_arrival: diffDays };
                }
                return { ...p, days_until_arrival: null };
            });

            const content = `
                <!-- Basic Information Grid -->
                <div class="basic-info-grid">
                    <div class="info-card">
                        <h6><i class="fas fa-info-circle me-2"></i>Basic Information</h6>
                        <table class="table table-sm mb-0">
                            <tr><th>SKU ID:</th><td><strong>${skuData.sku.sku_id}</strong></td></tr>
                            <tr><th>Description:</th><td>${skuData.sku.description}</td></tr>
                            <tr><th>Supplier:</th><td>${skuData.sku.supplier || 'N/A'}</td></tr>
                            <tr><th>ABC/XYZ:</th><td><span class="badge bg-info">${skuData.sku.abc_code}${skuData.sku.xyz_code}</span></td></tr>
                            <tr><th>Transfer Multiple:</th><td>${skuData.sku.transfer_multiple}</td></tr>
                        </table>
                    </div>

                    <div class="info-card">
                        <h6><i class="fas fa-warehouse me-2"></i>Current Inventory</h6>
                        <table class="table table-sm mb-0">
                            <tr><th>Burnaby:</th><td><strong>${skuData.sku.burnaby_qty || 0}</strong> units</td></tr>
                            <tr><th>Kentucky:</th><td><strong>${skuData.sku.kentucky_qty || 0}</strong> units</td></tr>
                            <tr><th>Last Updated:</th><td>${skuData.sku.last_updated || 'N/A'}</td></tr>
                        </table>
                    </div>

                    ${pendingWithDays.length > 0 ? `
                    <div class="info-card">
                        <h6><i class="fas fa-truck me-2"></i>Pending Inventory</h6>
                        <div class="pending-inventory-section">
                            ${pendingWithDays.map(p => `
                                <div class="pending-item ${p.is_estimated ? 'estimated' : ''}">
                                    <div class="row align-items-center">
                                        <div class="col-6">
                                            <strong>${p.quantity}</strong> units → ${p.destination}
                                        </div>
                                        <div class="col-6 text-end">
                                            ${p.days_until_arrival !== null ?
                                                `<span class="badge ${p.days_until_arrival <= 7 ? 'bg-success' : p.days_until_arrival <= 30 ? 'bg-warning' : 'bg-secondary'}">
                                                    ${p.days_until_arrival > 0 ? p.days_until_arrival + ' days' : 'Overdue'}
                                                </span>` :
                                                '<span class="badge bg-secondary">TBD</span>'
                                            }
                                        </div>
                                    </div>
                                    <small class="text-muted">
                                        Expected: ${p.expected_arrival || 'Estimated'}
                                        ${p.is_estimated ? '(estimated)' : '(confirmed)'}
                                    </small>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                </div>

                <!-- Sales History with Chart -->
                <div class="row">
                    <div class="col-12">
                        <h6 class="mt-3"><i class="fas fa-chart-line me-2"></i>Sales Trend Analysis</h6>
                        <div class="chart-container">
                            <canvas id="sales-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Sales Summary Table (now below chart) -->
                <div class="row mt-3">
                    <div class="col-12">
                        <h6><i class="fas fa-table me-2"></i>Sales History Summary</h6>
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-hover">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th>Month</th>
                                        <th>CA Sales</th>
                                        <th>US Sales</th>
                                        <th>Total</th>
                                        <th>CA Stockout</th>
                                        <th>US Stockout</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${salesWithTotals.map(s => `
                                        <tr ${(s.kentucky_stockout_days > 0 || s.burnaby_stockout_days > 0) ? 'class="table-warning"' : ''}>
                                            <td><small>${s.year_month}</small></td>
                                            <td>${s.burnaby_sales}</td>
                                            <td>${s.kentucky_sales}</td>
                                            <td><strong>${s.total_sales}</strong></td>
                                            <td>${s.burnaby_stockout_days > 0 ? '<span class="badge bg-warning">' + s.burnaby_stockout_days + '</span>' : '-'}</td>
                                            <td>${s.kentucky_stockout_days > 0 ? '<span class="badge bg-warning">' + s.kentucky_stockout_days + '</span>' : '-'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Export Buttons -->
                <div class="export-buttons">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-download me-2"></i>Export Options</h6>
                            <button type="button" class="btn btn-primary btn-sm" onclick="exportSkuSalesHistory('${skuData.sku.sku_id}')">
                                <i class="fas fa-file-csv me-1"></i>Export This SKU Sales History
                            </button>
                        </div>
                        <div class="col-md-6 text-end">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Export includes complete sales history, stockout data, and corrected demand calculations for this SKU
                            </small>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('sku-detail-content').innerHTML = content;

            // Render the sales chart after DOM is updated
            setTimeout(() => renderSalesChart(salesWithTotals, skuData.sku.sku_id), 100);
        }

        /**
         * Render interactive sales trend chart with stockout indicators
         *
         * Features:
         * - Multi-line chart showing Kentucky, Canada, and total sales
         * - Chronological ordering (oldest to newest, left to right)
         * - Stockout period highlighting with red background
         * - Tooltip with stockout day information
         * - Responsive design with proper axis labels
         *
         * @param {Array<Object>} salesData - Monthly sales data with totals
         * @param {string} salesData[].year_month - Month in YYYY-MM format
         * @param {number} salesData[].kentucky_sales - Kentucky warehouse sales
         * @param {number} salesData[].burnaby_sales - Burnaby warehouse sales
         * @param {number} salesData[].total_sales - Combined sales total
         * @param {number} salesData[].kentucky_stockout_days - Days out of stock
         * @param {string} skuId - SKU identifier for chart title
         */
        function renderSalesChart(salesData, skuId) {
            const canvas = document.getElementById('sales-chart');
            if (!canvas) return;

            // Destroy existing chart if it exists
            if (window.salesChart) {
                window.salesChart.destroy();
            }

            const ctx = canvas.getContext('2d');

            // Prepare chart data - reverse arrays so newest month appears on the right
            const labels = salesData.map(s => s.year_month).reverse();
            const kentuckySales = salesData.map(s => s.kentucky_sales || 0).reverse();
            const burnabySales = salesData.map(s => s.burnaby_sales || 0).reverse();
            const totalSales = salesData.map(s => s.total_sales || 0).reverse();
            const kentuckyStockoutDays = salesData.map(s => s.kentucky_stockout_days || 0).reverse();
            const burnabyStockoutDays = salesData.map(s => s.burnaby_stockout_days || 0).reverse();

            // Create stockout background annotations for both warehouses - adjust for reversed data
            const stockoutAnnotations = {};
            const maxSales = Math.max(...totalSales);

            salesData.forEach((s, originalIndex) => {
                const reversedIndex = salesData.length - 1 - originalIndex;

                // Kentucky stockout annotation (red)
                if (s.kentucky_stockout_days > 0) {
                    stockoutAnnotations[`kentucky-stockout-${reversedIndex}`] = {
                        type: 'box',
                        xMin: reversedIndex - 0.4,
                        xMax: reversedIndex + 0.4,
                        yMin: 0,
                        yMax: maxSales * 0.5,
                        backgroundColor: 'rgba(220, 53, 69, 0.15)',
                        borderColor: 'rgba(220, 53, 69, 0.4)',
                        borderWidth: 1
                    };
                }

                // Burnaby stockout annotation (orange)
                if (s.burnaby_stockout_days > 0) {
                    stockoutAnnotations[`burnaby-stockout-${reversedIndex}`] = {
                        type: 'box',
                        xMin: reversedIndex - 0.4,
                        xMax: reversedIndex + 0.4,
                        yMin: maxSales * 0.5,
                        yMax: maxSales * 1.1,
                        backgroundColor: 'rgba(255, 193, 7, 0.15)',
                        borderColor: 'rgba(255, 193, 7, 0.4)',
                        borderWidth: 1
                    };
                }
            });

            // Chart configuration
            const config = {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Kentucky Sales',
                            data: kentuckySales,
                            borderColor: '#007bff',
                            backgroundColor: 'rgba(0, 123, 255, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.2
                        },
                        {
                            label: 'Canada Sales',
                            data: burnabySales,
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.2
                        },
                        {
                            label: 'Total Sales',
                            data: totalSales,
                            borderColor: '#6f42c1',
                            backgroundColor: 'rgba(111, 66, 193, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Sales Trend - ${skuId}`,
                            font: { size: 14, weight: 'bold' }
                        },
                        legend: {
                            position: 'top',
                            labels: { usePointStyle: true }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                afterBody: function(tooltipItems) {
                                    const index = tooltipItems[0].dataIndex;
                                    const kentuckyStockouts = kentuckyStockoutDays[index];
                                    const burnabyStockouts = burnabyStockoutDays[index];

                                    const stockoutInfo = [];
                                    if (kentuckyStockouts > 0) {
                                        stockoutInfo.push(`🇺🇸 US Stockout: ${kentuckyStockouts} days`);
                                    }
                                    if (burnabyStockouts > 0) {
                                        stockoutInfo.push(`🇨🇦 CA Stockout: ${burnabyStockouts} days`);
                                    }

                                    return stockoutInfo;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Month' },
                            grid: { display: true, color: 'rgba(0,0,0,0.1)' }
                        },
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Units Sold' },
                            grid: { display: true, color: 'rgba(0,0,0,0.1)' }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            };

            // Create the chart
            window.salesChart = new Chart(ctx, config);

            // Add stockout markers for both warehouses - adjust for reversed data
            salesData.forEach((s, originalIndex) => {
                const reversedIndex = salesData.length - 1 - originalIndex;

                // Kentucky stockout marker (red)
                if (s.kentucky_stockout_days > 0) {
                    const kentuckyAnnotation = document.createElement('div');
                    kentuckyAnnotation.style.position = 'absolute';
                    kentuckyAnnotation.style.color = '#dc3545';
                    kentuckyAnnotation.style.fontSize = '12px';
                    kentuckyAnnotation.style.fontWeight = 'bold';
                    kentuckyAnnotation.innerHTML = '🇺🇸';
                    kentuckyAnnotation.title = `US Stockout: ${s.kentucky_stockout_days} days`;
                }

                // Burnaby stockout marker (orange)
                if (s.burnaby_stockout_days > 0) {
                    const burnabyAnnotation = document.createElement('div');
                    burnabyAnnotation.style.position = 'absolute';
                    burnabyAnnotation.style.color = '#ffc107';
                    burnabyAnnotation.style.fontSize = '12px';
                    burnabyAnnotation.style.fontWeight = 'bold';
                    burnabyAnnotation.innerHTML = '🇨🇦';
                    burnabyAnnotation.title = `CA Stockout: ${s.burnaby_stockout_days} days`;
                }
            });
        }

        /**
         * Export individual SKU sales history to CSV file
         *
         * Downloads a comprehensive CSV report containing:
         * - Monthly sales data for both warehouses
         * - Total sales calculations
         * - Stockout days tracking
         * - Corrected demand calculations
         *
         * @param {string} skuId - SKU identifier to export
         * @throws {Error} Shows alert dialog if export fails
         * @example
         * exportSkuSalesHistory('WDG-003'); // Downloads: sales-history-WDG-003-20250914.csv
         */
        async function exportSkuSalesHistory(skuId) {
            try {
                showLoading(true, 'Exporting SKU Sales History', 'Generating CSV file for ' + skuId);

                const response = await fetch(`/api/export/sales-history/${skuId}`);
                if (!response.ok) {
                    throw new Error(`Export failed: ${response.statusText}`);
                }

                // Get filename from response headers or create default
                const contentDisposition = response.headers.get('content-disposition');
                const filename = contentDisposition
                    ? contentDisposition.split('filename=')[1].replace(/"/g, '')
                    : `sales-history-${skuId}-${new Date().toISOString().split('T')[0]}.csv`;

                // Download the file
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                showLoading(false);
                alert(`Sales history exported successfully: ${filename}`);

            } catch (error) {
                console.error('SKU export error:', error);
                showLoading(false);
                alert(`Export failed: ${error.message}`);
            }
        }

        /**
         * Display modal for configurable bulk export of all SKUs
         *
         * Features:
         * - Column selection checkboxes (Total, Kentucky, Canada, Stockout data)
         * - Dynamic modal creation with Bootstrap 5 styling
         * - Form validation for minimum column selection
         *
         * @example
         * showExportAllModal(); // Opens bulk export configuration modal
         */
        function showExportAllModal() {
            const modalHTML = `
                <div class="modal fade" id="export-all-modal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title"><i class="fas fa-download me-2"></i>Export All SKUs Sales History</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p>Select which columns to include in the export:</p>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="export-total" checked>
                                    <label class="form-check-label" for="export-total">
                                        <strong>Total Sales</strong> (CA + US combined)
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="export-kentucky" checked>
                                    <label class="form-check-label" for="export-kentucky">
                                        <strong>Kentucky Sales</strong> (US warehouse)
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="export-canada" checked>
                                    <label class="form-check-label" for="export-canada">
                                        <strong>Canada Sales</strong> (Burnaby warehouse)
                                    </label>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="export-stockout" checked>
                                    <label class="form-check-label" for="export-stockout">
                                        <strong>Stockout Days</strong> and corrected demand
                                    </label>
                                </div>
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Note:</strong> Export will include all SKUs in the system with their complete sales history.
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="exportAllSalesHistory()">
                                    <i class="fas fa-download me-1"></i>Export CSV
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if present
            const existingModal = document.getElementById('export-all-modal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to DOM and show it
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            const modal = new bootstrap.Modal(document.getElementById('export-all-modal'));
            modal.show();

            // Clean up modal after hiding
            document.getElementById('export-all-modal').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        }

        /**
         * Export comprehensive sales history for all SKUs with configurable columns
         *
         * Process:
         * 1. Reads selected column preferences from modal checkboxes
         * 2. Validates at least one column is selected
         * 3. Calls backend API with column parameters
         * 4. Downloads generated CSV file
         * 5. Closes the export configuration modal
         *
         * @async
         * @throws {Error} Shows alert dialog if no columns selected or export fails
         * @example
         * exportAllSalesHistory(); // Exports based on selected checkboxes
         */
        async function exportAllSalesHistory() {
            try {
                // Get selected columns
                const columns = [];
                if (document.getElementById('export-total').checked) columns.push('total');
                if (document.getElementById('export-kentucky').checked) columns.push('kentucky');
                if (document.getElementById('export-canada').checked) columns.push('canada');
                if (document.getElementById('export-stockout').checked) columns.push('stockout');

                if (columns.length === 0) {
                    alert('Please select at least one column to export.');
                    return;
                }

                // Hide the export modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('export-all-modal'));
                modal.hide();

                showLoading(true, 'Exporting All SKUs Sales History', 'Generating comprehensive CSV file...');

                // Build query parameters
                const params = new URLSearchParams({ columns: columns.join(',') });
                const response = await fetch(`/api/export/all-sales-history?${params}`);

                if (!response.ok) {
                    throw new Error(`Export failed: ${response.statusText}`);
                }

                // Get filename from response headers
                const contentDisposition = response.headers.get('content-disposition');
                const filename = contentDisposition
                    ? contentDisposition.split('filename=')[1].replace(/"/g, '')
                    : `all-sales-history-${new Date().toISOString().split('T')[0]}.csv`;

                // Download the file
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                showLoading(false);
                alert(`All SKUs sales history exported successfully: ${filename}\n\nColumns included: ${columns.join(', ')}`);

            } catch (error) {
                console.error('Bulk export error:', error);
                showLoading(false);
                alert(`Export failed: ${error.message}`);
            }
        }

        /**
         * Show SKU filter modal
         */
        function showSkuFilterModal() {
            const modal = new bootstrap.Modal(document.getElementById('sku-filter-modal'));
            modal.show();
        }

        /**
         * Apply SKU filter based on user input
         *
         * Fixed version using unique filter identification for reliable cleanup
         */
        function applySkuFilter() {
            const input = document.getElementById('sku-filter-input').value.trim();

            if (!input) {
                clearSkuFilter();
                return;
            }

            // Parse SKU list - handle commas, newlines, and spaces
            const skuList = input
                .split(/[\n,\s]+/)
                .map(sku => sku.trim().toUpperCase())
                .filter(sku => sku.length > 0);

            if (skuList.length === 0) {
                alert('Please enter at least one SKU ID.');
                return;
            }

            // Clear any existing SKU filter first
            clearSkuFilter();

            // Create filter function with unique identifier
            const skuFilterFunction = function(settings, data, dataIndex) {
                const skuId = data[0]; // SKU ID is in first column
                return skuList.includes(skuId.toUpperCase());
            };

            // Add unique identifier to the function for reliable detection
            skuFilterFunction._isSkuFilter = true;
            skuFilterFunction._filterId = 'sku-filter-' + Date.now();

            // Apply custom filter to DataTable
            $.fn.dataTable.ext.search.push(skuFilterFunction);

            // Redraw table
            if (window.transferTable) {
                window.transferTable.draw();
            }

            // Update status with better formatting
            const statusText = skuList.length === 1
                ? `Filtering by 1 SKU: ${skuList[0]}`
                : `Filtering by ${skuList.length} SKUs: ${skuList.slice(0, 3).join(', ')}${skuList.length > 3 ? ` and ${skuList.length - 3} more...` : ''}`;

            document.getElementById('filter-status').textContent = statusText;

            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('sku-filter-modal'));
            modal.hide();

            // Store filter state
            window.activeSkuFilter = {
                skuList: skuList,
                filterId: skuFilterFunction._filterId,
                applied: new Date().toISOString()
            };

            console.log('SKU filter applied:', window.activeSkuFilter);
        }

        /**
         * Clear SKU filter
         *
         * Fixed version using reliable filter identification
         */
        function clearSkuFilter() {
            // Remove SKU filter functions using unique identifier
            const originalLength = $.fn.dataTable.ext.search.length;

            $.fn.dataTable.ext.search = $.fn.dataTable.ext.search.filter(
                function(fn) {
                    // Remove functions marked as SKU filters
                    return !fn._isSkuFilter;
                }
            );

            const filtersRemoved = originalLength - $.fn.dataTable.ext.search.length;

            if (filtersRemoved > 0) {
                console.log(`Removed ${filtersRemoved} SKU filter(s)`);
            }

            // Redraw table
            if (window.transferTable) {
                window.transferTable.draw();
            }

            // Clear input and status
            document.getElementById('sku-filter-input').value = '';
            document.getElementById('filter-status').textContent = 'No filter applied';

            // Clear stored filter state
            window.activeSkuFilter = null;

            console.log('SKU filter cleared');
        }

        /**
         * Apply selected filters to the transfer recommendations table
         *
         * Filters data based on priority level, ABC classification, and minimum quantity,
         * then refreshes the DataTable display
         *
         * @function applyFilters
         * @returns {void}
         */
        function applyFilters() {
            const priority = document.getElementById('priority-filter').value;
            const abc = document.getElementById('abc-filter').value;
            const supplier = document.getElementById('supplier-filter').value;
            const minQty = parseInt(document.getElementById('min-qty-filter').value) || 0;
            const showRecommendationsOnly = document.getElementById('show-recommendations-only').checked;

            let filteredData = recommendationsData;

            if (priority) {
                filteredData = filteredData.filter(r => r.priority === priority);
            }

            if (abc) {
                filteredData = filteredData.filter(r => r.abc_class === abc);
            }

            if (supplier) {
                filteredData = filteredData.filter(r => r.supplier === supplier);
            }

            if (minQty > 0) {
                filteredData = filteredData.filter(r => r.recommended_transfer_qty >= minQty);
            }

            if (showRecommendationsOnly) {
                filteredData = filteredData.filter(r => r.recommended_transfer_qty > 0);
            }

            // Update table with filtered data
            dataTable.clear();
            filteredData.forEach(rec => {
                const row = createTableRow(rec);
                dataTable.row.add($(row));
            });
            dataTable.draw();
        }

        /**
         * Clear all active filters and reset table display
         *
         * Resets all filter controls to default values and repopulates
         * the table with unfiltered data
         *
         * @function clearFilters
         * @returns {void}
         */
        function clearFilters() {
            document.getElementById('priority-filter').value = '';
            document.getElementById('abc-filter').value = '';
            document.getElementById('supplier-filter').value = '';
            document.getElementById('min-qty-filter').value = '';
            document.getElementById('show-recommendations-only').checked = false;
            populateTable();
        }

        /**
         * Select all high priority and critical SKUs for bulk operations
         *
         * Automatically checks the selection boxes for all CRITICAL and HIGH priority
         * transfer recommendations
         *
         * @function selectHighPriority
         * @returns {void}
         */
        function selectHighPriority() {
            // Uncheck all first
            document.querySelectorAll('.row-select').forEach(cb => cb.checked = false);
            
            // Check high priority items
            recommendationsData.forEach(rec => {
                if (rec.priority === 'CRITICAL' || rec.priority === 'HIGH') {
                    const checkbox = document.querySelector(`.row-select[value="${rec.sku_id}"]`);
                    if (checkbox) checkbox.checked = true;
                }
            });
        }

        /**
         * Open bulk edit dialog for selected SKUs
         *
         * Allows modification of transfer quantities for multiple selected SKUs
         * with options to set fixed amounts or percentage adjustments
         *
         * @function bulkEditSelected
         * @returns {void}
         */
        function bulkEditSelected() {
            const selected = Array.from(document.querySelectorAll('.row-select:checked')).map(cb => cb.value);
            if (selected.length === 0) {
                alert('Please select at least one item to edit.');
                return;
            }
            
            const adjustment = prompt(`Enter adjustment for ${selected.length} selected items:\n• Enter a number to set exact quantity\n• Enter +N or -N to adjust by amount`);
            if (!adjustment) return;
            
            selected.forEach(skuId => {
                const input = document.querySelector(`.editable-qty[data-sku="${skuId}"]`);
                if (input) {
                    let newValue;
                    if (adjustment.startsWith('+') || adjustment.startsWith('-')) {
                        newValue = parseInt(input.value) + parseInt(adjustment);
                    } else {
                        newValue = parseInt(adjustment);
                    }
                    
                    if (newValue >= 0) {
                        input.value = newValue;
                        updateTransferQty(skuId, newValue);
                    }
                }
            });
        }

        /**
         * Export transfer order in Excel format with professional formatting
         *
         * Creates formatted Excel file with transfer recommendations,
         * including company branding, data validation, and conditional formatting
         *
         * @async
         * @function exportTransferOrderExcel
         * @returns {Promise<void>}
         * @throws {Error} Shows alert if export fails
         */
        async function exportTransferOrderExcel() {
            showLoading(true, 'Generating Excel File', 'Creating professional Excel export with formatting...');

            try {
                // Set extended timeout for Excel export (2 minutes)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 120000);

                const response = await fetch('/api/export/excel/transfer-orders', {
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`Export failed: ${response.statusText}`);
                }

                // Get filename from response headers
                const contentDisposition = response.headers.get('content-disposition');
                const filename = contentDisposition
                    ? contentDisposition.split('filename=')[1].replace(/"/g, '')
                    : `transfer-orders-${new Date().toISOString().split('T')[0]}.xlsx`;

                // Download file
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                // Show success message
                setTimeout(() => {
                    alert(`Excel file exported successfully: ${filename}\n\nThe file includes:\n• Transfer recommendations with color coding\n• Summary statistics\n• Current inventory status`);
                }, 500);

            } catch (error) {
                console.error('Excel export error:', error);
                if (error.name === 'AbortError') {
                    alert('Excel export timed out. Please try again or contact support if the issue persists.');
                } else {
                    alert(`Excel export failed: ${error.message}`);
                }
            } finally {
                showLoading(false);
            }
        }

        /**
         * Export transfer order in CSV format
         *
         * Downloads transfer recommendations as CSV file with current quantities
         * and basic transfer information for warehouse processing
         *
         * @function exportTransferOrder
         * @returns {void}
         */
        function exportTransferOrder() {
            // Use backend CSV export for consistency and performance
            showLoading(true, 'Generating CSV Export', 'Creating CSV file with all transfer recommendations...');

            // Use the backend CSV export endpoint for better performance and consistency
            fetch('/api/export/csv/transfer-orders')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Export failed: ${response.statusText}`);
                    }

                    // Get filename from response headers
                    const contentDisposition = response.headers.get('content-disposition');
                    const filename = contentDisposition
                        ? contentDisposition.split('filename=')[1].replace(/"/g, '')
                        : `transfer-orders-${new Date().toISOString().split('T')[0]}.csv`;

                    return response.blob().then(blob => ({ blob, filename }));
                })
                .then(({ blob, filename }) => {
                    // Download file
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);

                    setTimeout(() => {
                        alert(`CSV file exported successfully: ${filename}\n\nThe file includes all transfer recommendations with current data.`);
                    }, 500);
                })
                .catch(error => {
                    console.error('CSV export error:', error);
                    alert(`CSV export failed: ${error.message}`);
                })
                .finally(() => {
                    showLoading(false);
                });
        }

        /**
         * Show or hide loading overlay with custom messages
         *
         * Displays loading spinner with configurable title and message
         * for better user experience during API operations
         *
         * @function showLoading
         * @param {boolean} show - Whether to show (true) or hide (false) loading overlay
         * @param {string} [title='Loading Transfer Recommendations...'] - Custom loading title
         * @param {string} [message='Analyzing stockout data and calculating optimal quantities'] - Custom loading message
         * @returns {void}
         */
        function showLoading(show, title = 'Loading Transfer Recommendations...', message = 'Analyzing stockout data and calculating optimal quantities') {
            const overlay = document.getElementById('loading-overlay');
            if (show) {
                // Update loading text if title/message provided
                const titleEl = overlay.querySelector('h5');
                const messageEl = overlay.querySelector('p');
                if (titleEl && title) titleEl.textContent = title;
                if (messageEl && message) messageEl.textContent = message;
                overlay.style.display = 'flex';
            } else {
                overlay.style.display = 'none';
                // Reset to default text
                const titleEl = overlay.querySelector('h5');
                const messageEl = overlay.querySelector('p');
                if (titleEl) titleEl.textContent = 'Loading Transfer Recommendations...';
                if (messageEl) messageEl.textContent = 'Analyzing stockout data and calculating optimal quantities';
            }
        }

        /**
         * Display error message to user
         *
         * Shows error alert dialog for API failures or validation errors
         *
         * @function showError
         * @param {string} message - Error message to display to user
         * @returns {void}
         */
        function showError(message) {
            alert(message);
        }

        /**
         * Update displayed timestamps with formatted date/time
         *
         * Updates both last updated and generation time displays
         * with properly formatted locale-specific timestamps
         *
         * @function updateTimestamp
         * @param {string} timestamp - ISO timestamp string to format and display
         * @returns {void}
         */
        function updateTimestamp(timestamp) {
            const formatted = new Date(timestamp).toLocaleString();
            document.getElementById('last-updated').textContent = `Last updated: ${formatted}`;
            document.getElementById('generation-time').textContent = formatted;
        }

        /**
         * Refresh transfer recommendations from server
         *
         * Reloads all transfer recommendation data and updates display
         * without requiring page refresh
         *
         * @async
         * @function refreshRecommendations
         * @returns {Promise<void>}
         */
        async function refreshRecommendations() {
            await loadRecommendations();
        }

        // Handle select all checkbox
        document.getElementById('select-all').addEventListener('change', function() {
            const isChecked = this.checked;
            document.querySelectorAll('.row-select').forEach(cb => {
                cb.checked = isChecked;
            });
        });

        // Cache Management Functions

        /**
         * Check and display current cache status
         * Shows cache statistics and last updated time
         */
        async function checkCacheStatus() {
            try {
                const response = await fetch('/api/cache/status');

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                updateCacheStatusDisplay(data);

            } catch (error) {
                console.error('Failed to check cache status:', error);
                document.getElementById('cache-status').textContent = 'Error';
                document.getElementById('cache-status').className = 'badge bg-danger';
                document.getElementById('cache-last-updated').textContent = 'Failed to load';
            }
        }

        /**
         * Update cache status display elements
         * @param {Object} statusData Cache status data from API
         */
        function updateCacheStatusDisplay(statusData) {
            const statusElement = document.getElementById('cache-status');
            const lastUpdatedElement = document.getElementById('cache-last-updated');

            if (statusData.error) {
                statusElement.textContent = 'Error';
                statusElement.className = 'badge bg-danger';
                lastUpdatedElement.textContent = 'Failed to load';
                return;
            }

            const totalSkus = statusData.total_cached_skus || 0;
            const validSkus = statusData.valid_cached_skus || 0;
            const hitRate = statusData.overall_hit_rate || 0;

            if (validSkus > 0) {
                statusElement.textContent = `${validSkus.toLocaleString()} SKUs cached (${hitRate.toFixed(1)}% hit rate)`;
                statusElement.className = 'badge bg-success';
            } else {
                statusElement.textContent = 'Cache empty';
                statusElement.className = 'badge bg-warning';
            }

            // Format last updated time
            if (statusData.last_updated) {
                const lastUpdated = new Date(statusData.last_updated);
                lastUpdatedElement.textContent = lastUpdated.toLocaleString();
            } else {
                lastUpdatedElement.textContent = 'Never';
            }
        }

        /**
         * Initiate cache refresh with user confirmation
         * Shows progress and handles background refresh
         */
        async function refreshCache() {
            // Confirmation dialog
            const confirmed = confirm(
                'Refresh weighted demand calculations?\n\n' +
                'This includes:\n' +
                '• Stockout corrections\n' +
                '• Seasonal adjustments\n' +
                '• Volatility analysis\n\n' +
                'Takes ~20 minutes in background.'
            );

            if (!confirmed) {
                return;
            }

            try {
                // Show progress indicator
                showCacheRefreshProgress(true);

                // Disable refresh button
                const refreshBtn = document.getElementById('refresh-cache-btn');
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Refreshing...';

                // Start cache refresh
                const response = await fetch('/api/cache/refresh-weighted-demand', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        force_refresh: true
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                // Simulate progress (since we don't have real-time progress)
                await simulateProgress();

                // Show success message
                alert(
                    'Cache refresh completed successfully!\n\n' +
                    `Processing time: ${result.summary?.duration_seconds?.toFixed(1) || 'N/A'}s\n` +
                    `SKUs processed: ${result.summary?.processed_skus || 'N/A'}\n` +
                    `Successful calculations: ${result.summary?.successful_calculations || 'N/A'}\n\n` +
                    'Transfer planning page should now load much faster!'
                );

                // Refresh cache status display
                await checkCacheStatus();

            } catch (error) {
                console.error('Cache refresh failed:', error);
                alert(`Cache refresh failed: ${error.message}\n\nPlease try again or contact support.`);

            } finally {
                // Reset UI
                showCacheRefreshProgress(false);
                const refreshBtn = document.getElementById('refresh-cache-btn');
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = '<i class="fas fa-sync me-1"></i>Refresh Cache';
            }
        }

        /**
         * Show/hide cache refresh progress indicator
         * @param {boolean} show Whether to show or hide progress
         */
        function showCacheRefreshProgress(show) {
            const progressContainer = document.getElementById('cache-refresh-progress');
            const progressBar = document.getElementById('cache-progress-bar');
            const progressText = document.getElementById('cache-progress-text');

            if (show) {
                progressContainer.style.display = 'block';
                progressBar.style.width = '0%';
                progressText.textContent = '0%';
            } else {
                progressContainer.style.display = 'none';
            }
        }

        /**
         * Simulate progress updates during cache refresh
         * Since we don't have real-time progress, simulate realistic progress
         */
        async function simulateProgress() {
            const progressBar = document.getElementById('cache-progress-bar');
            const progressText = document.getElementById('cache-progress-text');

            // Simulate realistic progress over ~2 seconds
            const steps = [
                { percent: 10, delay: 200 },
                { percent: 25, delay: 300 },
                { percent: 50, delay: 500 },
                { percent: 75, delay: 400 },
                { percent: 90, delay: 300 },
                { percent: 100, delay: 200 }
            ];

            for (const step of steps) {
                await new Promise(resolve => setTimeout(resolve, step.delay));
                progressBar.style.width = `${step.percent}%`;
                progressText.textContent = `${step.percent}%`;
            }
        }

        // Initialize cache status when page loads
        $(document).ready(function() {
            // Check cache status after other initialization
            setTimeout(checkCacheStatus, 1000);
        });
    </script>
</body>
</html>