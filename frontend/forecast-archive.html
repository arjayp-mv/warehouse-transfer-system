<!DOCTYPE html>
<!--
Warehouse Transfer Planning Tool - Forecast Archive
====================================================
Purpose: View and manage archived forecast runs
Features: List archived forecasts, bulk/single unarchive, search/filter
Business Impact: Historical forecast tracking without cluttering main view
-->
<html lang="en">
<head>
    <!-- Meta Configuration -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forecast Archive - Warehouse Transfer Tool</title>

    <!-- CSS Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">

    <style>
        /* Archive-specific styling */
        .archive-badge {
            background-color: #6c757d;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: bold;
        }

        /* Status Badges */
        .status-pending { background-color: #6c757d; }
        .status-running { background-color: #007bff; }
        .status-completed { background-color: #28a745; }
        .status-failed { background-color: #dc3545; }
        .status-cancelled { background-color: #ffc107; }
        .status-queued { background-color: #17a2b8; }

        /* DataTable Customization */
        .dataTables_wrapper .dataTables_length select,
        .dataTables_wrapper .dataTables_filter input {
            border: 1px solid #ced4da;
            border-radius: 4px;
            padding: 4px 8px;
        }

        /* Alert Styling */
        .alert-dismissible {
            position: relative;
        }

        .select-checkbox {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/static/index.html">
                <i class="fas fa-warehouse me-2"></i>
                Warehouse Transfer Tool
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/static/index.html">
                            <i class="fas fa-home me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/static/forecasting.html">
                            <i class="fas fa-chart-line me-1"></i>Forecasts
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/static/forecast-archive.html">
                            <i class="fas fa-archive me-1"></i>Archive
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2>
                            <i class="fas fa-archive text-secondary me-2"></i>
                            Forecast Archive
                        </h2>
                        <p class="text-muted mb-0">
                            View and restore archived forecast runs
                        </p>
                    </div>
                    <a href="/static/forecasting.html" class="btn btn-primary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Forecasts
                    </a>
                </div>
            </div>
        </div>

        <!-- Alert Messages -->
        <div id="alertContainer"></div>

        <!-- Archived Forecasts Table -->
        <div class="row">
            <div class="col-md-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-secondary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-history me-2"></i>
                                Archived Forecast Runs
                            </h5>
                            <button id="bulkUnarchiveBtn" class="btn btn-warning btn-sm" style="display: none;" onclick="bulkUnarchiveForecasts()">
                                <i class="fas fa-undo"></i> Restore Selected (<span id="selectedCount">0</span>)
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <table id="archivedForecastsTable" class="table table-hover table-striped">
                            <thead>
                                <tr>
                                    <th style="width: 40px;">
                                        <input type="checkbox" id="selectAllCheckbox" onclick="toggleSelectAll()">
                                    </th>
                                    <th>Name</th>
                                    <th>Status</th>
                                    <th>SKUs</th>
                                    <th>Created</th>
                                    <th>Duration</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Dependencies -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

    <script>
        const API_BASE = '/api/forecasts';
        let archivedForecastsTable;

        // Initialize on page load
        $(document).ready(function() {
            initializeDataTable();
            loadArchivedForecasts();
        });

        /**
         * Initialize DataTables for archived forecasts
         */
        function initializeDataTable() {
            archivedForecastsTable = $('#archivedForecastsTable').DataTable({
                pageLength: 25,
                order: [[4, 'desc']], // Sort by created date
                columns: [
                    {
                        data: null,
                        render: renderCheckbox,
                        orderable: false,
                        className: 'select-checkbox'
                    },
                    { data: 'name' },
                    { data: 'status', render: renderStatusBadge },
                    { data: 'total_skus' },
                    {
                        data: 'created_at',
                        render: function(data, type, row) {
                            if (type === 'sort' || type === 'type') {
                                return data || '';
                            }
                            return renderDate(data);
                        }
                    },
                    { data: 'duration_seconds', render: renderDuration },
                    { data: null, render: renderArchiveActions, orderable: false }
                ]
            });
        }

        /**
         * Load archived forecasts from API
         */
        async function loadArchivedForecasts() {
            try {
                const response = await fetch(`${API_BASE}/runs/archived`);
                if (response.ok) {
                    const data = await response.json();
                    archivedForecastsTable.clear();
                    archivedForecastsTable.rows.add(data);
                    archivedForecastsTable.draw();
                } else {
                    showError('Failed to load archived forecasts');
                }
            } catch (error) {
                showError('Network error: ' + error.message);
            }
        }

        /**
         * Render checkbox for bulk operations
         */
        function renderCheckbox(data, type, row) {
            return `<input type="checkbox" class="forecast-checkbox" data-run-id="${row.run_id}" onchange="updateBulkUnarchiveButton()">`;
        }

        /**
         * Render status badge
         */
        function renderStatusBadge(data, type, row) {
            const statusClasses = {
                'pending': 'status-pending',
                'queued': 'status-queued',
                'running': 'status-running',
                'completed': 'status-completed',
                'failed': 'status-failed',
                'cancelled': 'status-cancelled'
            };
            const badgeClass = statusClasses[data] || 'status-pending';
            return `<span class="badge ${badgeClass}">${data.toUpperCase()}</span>`;
        }

        /**
         * Render date in readable format
         */
        function renderDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        /**
         * Render duration in readable format
         */
        function renderDuration(seconds) {
            if (!seconds) return 'N/A';
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes}m ${secs}s`;
        }

        /**
         * Render action buttons for archived forecasts
         */
        function renderArchiveActions(data, type, row) {
            return `
                <button class="btn btn-sm btn-warning" onclick="unarchiveForecast(${row.run_id}, '${row.name}')">
                    <i class="fas fa-undo"></i> Restore
                </button>
                <button class="btn btn-sm btn-info" onclick="viewForecast(${row.run_id})">
                    <i class="fas fa-eye"></i> View
                </button>
            `;
        }

        /**
         * Toggle select all checkboxes
         */
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAllCheckbox');
            const checkboxes = document.querySelectorAll('.forecast-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = selectAll.checked;
            });
            updateBulkUnarchiveButton();
        }

        /**
         * Update bulk unarchive button visibility
         */
        function updateBulkUnarchiveButton() {
            const checked = document.querySelectorAll('.forecast-checkbox:checked');
            const count = checked.length;
            const btn = document.getElementById('bulkUnarchiveBtn');
            const countSpan = document.getElementById('selectedCount');

            if (count > 0) {
                btn.style.display = 'inline-block';
                countSpan.textContent = count;
            } else {
                btn.style.display = 'none';
                document.getElementById('selectAllCheckbox').checked = false;
            }
        }

        /**
         * Unarchive single forecast
         */
        async function unarchiveForecast(runId, name) {
            if (!confirm(`Restore "${name}" to main forecasts view?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/runs/${runId}/unarchive`, {
                    method: 'POST'
                });

                if (response.ok) {
                    const data = await response.json();
                    showSuccess(data.message || 'Forecast restored successfully');
                    loadArchivedForecasts();
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    showError(errorData.detail || 'Failed to restore forecast');
                }
            } catch (error) {
                showError('Network error: ' + error.message);
            }
        }

        /**
         * Bulk unarchive forecasts with confirmation
         */
        async function bulkUnarchiveForecasts() {
            const checked = document.querySelectorAll('.forecast-checkbox:checked');
            const runIds = Array.from(checked).map(cb => parseInt(cb.dataset.runId));

            if (runIds.length === 0) {
                showError('No forecasts selected');
                return;
            }

            // Simple confirmation for restore
            const confirmMsg = `Are you sure you want to restore ${runIds.length} forecast(s) to the main view?`;
            if (!confirm(confirmMsg)) {
                return;
            }

            try {
                // Call unarchive endpoint for each forecast
                const promises = runIds.map(runId =>
                    fetch(`${API_BASE}/runs/${runId}/unarchive`, { method: 'POST' })
                );

                const results = await Promise.all(promises);
                const successCount = results.filter(r => r.ok).length;
                const failCount = results.length - successCount;

                if (failCount === 0) {
                    showSuccess(`Successfully restored ${successCount} forecast(s)`);
                } else {
                    showWarning(`Restored ${successCount} forecast(s), ${failCount} failed`);
                }

                // Clear selections and reload table
                document.getElementById('selectAllCheckbox').checked = false;
                updateBulkUnarchiveButton();
                loadArchivedForecasts();

            } catch (error) {
                showError('Network error: ' + error.message);
            }
        }

        /**
         * View forecast details (redirects to main forecasting page)
         */
        function viewForecast(runId) {
            window.location.href = `/static/forecasting.html?run_id=${runId}`;
        }

        /**
         * Show success message
         */
        function showSuccess(message) {
            showAlert(message, 'success');
        }

        /**
         * Show error message
         */
        function showError(message) {
            showAlert(message, 'danger');
        }

        /**
         * Show warning message
         */
        function showWarning(message) {
            showAlert(message, 'warning');
        }

        /**
         * Show alert message
         */
        function showAlert(message, type) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            $('#alertContainer').html(alertHtml);

            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                $('.alert').fadeOut(300, function() {
                    $(this).remove();
                });
            }, 5000);
        }
    </script>
</body>
</html>
