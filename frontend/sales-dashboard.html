<!DOCTYPE html>
<!--
Sales Analytics Dashboard - Warehouse Transfer Planning Tool
Multi-SKU sales overview with revenue trends, performance metrics, and insights.
Completely separate from transfer planning to maintain system stability.
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Analytics Dashboard - Warehouse Transfer Tool</title>

    <!-- Bootstrap CSS for responsive layout and components -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- DataTables CSS for advanced table features -->
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css" rel="stylesheet">

    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary-blue: #2563eb;
            --success-green: #059669;
            --warning-orange: #d97706;
            --danger-red: #dc2626;
            --light-gray: #f8fafc;
            --border-gray: #e2e8f0;
        }

        body {
            background-color: var(--light-gray);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-blue), #1e40af);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            font-weight: 600;
            font-size: 1.25rem;
        }

        .nav-link {
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9) !important;
            transition: color 0.2s;
        }

        .nav-link:hover {
            color: white !important;
        }

        .kpi-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: none;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
        }

        .kpi-label {
            color: #6b7280;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .kpi-trend {
            font-size: 0.875rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        .trend-positive {
            color: var(--success-green);
        }

        .trend-negative {
            color: var(--danger-red);
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #1f2937;
        }

        .section-header {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }

        .section-subtitle {
            color: #6b7280;
            margin: 0.5rem 0 0 0;
        }

        .filter-card {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 1rem;
        }

        .btn-primary {
            background: var(--primary-blue);
            border-color: var(--primary-blue);
            font-weight: 500;
        }

        .btn-outline-primary {
            color: var(--primary-blue);
            border-color: var(--primary-blue);
            font-weight: 500;
        }

        .table-container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .badge {
            font-weight: 500;
        }

        .abc-badge-A { background-color: var(--success-green); }
        .abc-badge-B { background-color: var(--warning-orange); }
        .abc-badge-C { background-color: #6b7280; }

        .xyz-badge-X { background-color: var(--primary-blue); }
        .xyz-badge-Y { background-color: var(--warning-orange); }
        .xyz-badge-Z { background-color: var(--danger-red); }

        .loading-spinner {
            display: none;
            justify-content: center;
            align-items: center;
            height: 200px;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            border-radius: 12px;
        }

        .progress-container {
            position: relative;
            width: 100%;
            max-width: 300px;
            text-align: center;
        }

        .progress-spinner {
            margin-bottom: 1rem;
        }

        .progress-text {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .progress-bar-custom {
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-blue), #3b82f6);
            border-radius: 2px;
            width: 0%;
            transition: width 0.3s ease;
        }

        .chart-container {
            position: relative;
        }

        .table-container {
            position: relative;
        }

        .kpi-card {
            position: relative;
        }

        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .skeleton-line {
            height: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 4px;
        }

        .skeleton-line.short {
            width: 60%;
        }

        .skeleton-line.medium {
            width: 80%;
        }

        .skeleton-line.long {
            width: 100%;
        }

        /* Tooltip Styles */
        .tooltip-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            background: var(--primary-blue);
            border-radius: 50%;
            color: white;
            text-align: center;
            line-height: 16px;
            font-size: 10px;
            margin-left: 5px;
            cursor: help;
            position: relative;
        }

        .custom-tooltip {
            position: absolute;
            background: #1f2937;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            white-space: nowrap;
            z-index: 1050;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-5px);
            transition: all 0.2s ease;
        }

        .custom-tooltip.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .custom-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: #1f2937;
        }

        /* Error Handling Styles */
        .error-boundary {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .error-title {
            color: var(--danger-red);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .error-details {
            color: #6b7280;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .error-actions {
            display: flex;
            gap: 0.5rem;
        }

        .retry-btn {
            background: var(--danger-red);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .retry-btn:hover {
            background: #b91c1c;
        }

        .dismiss-btn {
            background: transparent;
            border: 1px solid #d1d5db;
            color: #6b7280;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .dismiss-btn:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }

        .connection-status {
            position: fixed;
            top: 70px;
            right: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 0.75rem 1rem;
            z-index: 1060;
            display: none;
        }

        .connection-status.online {
            border-left: 4px solid var(--success-green);
        }

        .connection-status.offline {
            border-left: 4px solid var(--danger-red);
        }

        .form-help {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: var(--danger-red);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            display: none;
        }

        .warehouse-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 1rem;
        }

        .warehouse-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .warehouse-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .metric-label {
            color: #6b7280;
        }

        .metric-value {
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .warehouse-comparison {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }
    </style>
</head>

<body>
    <!-- Navigation Header -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-chart-line me-2"></i>
                Sales Analytics Dashboard
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/static/sales-dashboard.html">
                            <i class="fas fa-chart-bar me-1"></i>
                            Sales Overview
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/static/sku-analysis.html">
                            <i class="fas fa-search me-1"></i>
                            SKU Analysis
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/static/transfer-planning.html">
                            <i class="fas fa-truck me-1"></i>
                            Transfer Planning
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/static/index.html">
                            <i class="fas fa-home me-1"></i>
                            Dashboard
                        </a>
                    </li>
                </ul>

                <div class="navbar-text">
                    <span id="last-updated" class="small">Loading...</span>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <!-- Page Header -->
        <div class="section-header">
            <h1 class="section-title">Sales Analytics Overview</h1>
            <p class="section-subtitle">
                Multi-SKU performance analysis, revenue trends, and warehouse comparison
            </p>
        </div>

        <!-- KPI Cards Row -->
        <div class="row mb-4" id="kpi-container">
            <div class="col-md-3 mb-3">
                <div class="kpi-card card h-100 text-center">
                    <div class="card-body">
                        <p class="kpi-label">Total Revenue</p>
                        <h2 class="kpi-value" id="total-revenue">$0</h2>
                        <div class="kpi-trend" id="revenue-trend">
                            <i class="fas fa-arrow-up trend-positive"></i> 0%
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3 mb-3">
                <div class="kpi-card card h-100 text-center">
                    <div class="card-body">
                        <p class="kpi-label">Average Monthly</p>
                        <h2 class="kpi-value" id="avg-monthly">$0</h2>
                        <div class="kpi-trend" id="monthly-trend">
                            <i class="fas fa-minus text-muted"></i> 0%
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3 mb-3">
                <div class="kpi-card card h-100 text-center">
                    <div class="card-body">
                        <p class="kpi-label">Stockout Impact</p>
                        <h2 class="kpi-value" id="stockout-loss">$0</h2>
                        <div class="kpi-trend text-danger">
                            <i class="fas fa-exclamation-triangle"></i> Estimated Loss
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3 mb-3">
                <div class="kpi-card card h-100 text-center">
                    <div class="card-body">
                        <p class="kpi-label">Analysis Period</p>
                        <h2 class="kpi-value" id="period-months">12</h2>
                        <div class="kpi-trend text-muted">
                            <i class="fas fa-calendar"></i> Months
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters Row -->
        <div class="filter-card">
            <div class="row align-items-center">
                <div class="col-md-3">
                    <label for="monthsBack" class="form-label">Analysis Period</label>
                    <select id="monthsBack" class="form-select">
                        <option value="6">Last 6 Months</option>
                        <option value="12" selected>Last 12 Months</option>
                        <option value="24">Last 24 Months</option>
                        <option value="36">Last 36 Months</option>
                    </select>
                    <div class="form-help">Longer periods provide more stable trends but may include outdated patterns.</div>
                </div>
                <div class="col-md-3">
                    <label for="warehouseFilter" class="form-label">Warehouse</label>
                    <select id="warehouseFilter" class="form-select">
                        <option value="">Both Warehouses</option>
                        <option value="burnaby">Burnaby Only</option>
                        <option value="kentucky">Kentucky Only</option>
                    </select>
                    <div class="form-help">Filter data by specific warehouse. "Both" shows combined metrics.</div>
                </div>
                <div class="col-md-3">
                    <label for="performanceMetric" class="form-label">Performance Metric</label>
                    <select id="performanceMetric" class="form-select">
                        <option value="revenue">Revenue</option>
                        <option value="units">Units Sold</option>
                        <option value="growth">Growth Rate</option>
                    </select>
                    <div class="form-help">Choose ranking metric: Revenue (total sales), Units (quantity), Growth (% increase).</div>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button id="refreshBtn" class="btn btn-primary me-2">
                        <i class="fas fa-sync-alt me-1"></i>
                        Refresh
                    </button>
                    <button id="exportBtn" class="btn btn-outline-primary">
                        <i class="fas fa-download me-1"></i>
                        Export
                    </button>
                </div>
            </div>
        </div>

        <!-- Revenue Trends Chart -->
        <div class="chart-container">
            <h3 class="chart-title">Revenue Trends Over Time</h3>
            <div class="loading-spinner" id="trends-loading">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
            <canvas id="revenueTrendsChart" style="max-height: 400px;"></canvas>
        </div>

        <!-- Seasonal Analysis Chart -->
        <div class="chart-container">
            <h3 class="chart-title">Seasonal Analysis</h3>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="seasonalSku" class="form-label">Select SKU for Seasonal Analysis</label>
                    <select id="seasonalSku" class="form-select">
                        <option value="">Overall Sales Pattern</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="seasonalPeriod" class="form-label">Analysis Period</label>
                    <select id="seasonalPeriod" class="form-select">
                        <option value="18">18 Months</option>
                        <option value="24" selected>24 Months</option>
                        <option value="36">36 Months</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button id="loadSeasonalBtn" class="btn btn-primary">
                        <i class="fas fa-sync-alt me-1"></i>
                        Analyze
                    </button>
                </div>
            </div>
            <div class="loading-spinner" id="seasonal-loading">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading seasonal analysis...</span>
                </div>
            </div>
            <canvas id="seasonalChart" style="max-height: 400px;"></canvas>

            <div id="seasonal-insights" class="mt-3" style="display: none;">
                <div class="alert alert-info">
                    <h6><i class="fas fa-lightbulb me-2"></i>Seasonal Insights</h6>
                    <div id="seasonal-insights-content"></div>
                </div>
            </div>

            <!-- Business Insights Panel -->
            <div id="seasonal-business-insights" class="card border-primary mt-3" style="display: none;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>What This Means for Your Business</h5>
                </div>
                <div class="card-body">
                    <div id="seasonal-recommendations" class="row">
                        <!-- Recommendations will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Stockout Impact Pareto Chart -->
        <div class="chart-container">
            <h3 class="chart-title">Stockout Impact Analysis (Pareto Chart)</h3>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="stockoutPeriod" class="form-label">Analysis Period</label>
                    <select id="stockoutPeriod" class="form-select">
                        <option value="6">Last 6 Months</option>
                        <option value="12" selected>Last 12 Months</option>
                        <option value="18">Last 18 Months</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="minStockoutImpact" class="form-label">Min Impact ($)</label>
                    <input type="number" id="minStockoutImpact" class="form-control" placeholder="100" value="100" min="0" step="50">
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button id="loadStockoutBtn" class="btn btn-primary">
                        <i class="fas fa-chart-bar me-1"></i>
                        Analyze
                    </button>
                </div>
            </div>
            <div class="loading-spinner" id="stockout-loading">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading stockout analysis...</span>
                </div>
            </div>
            <canvas id="stockoutParetoChart" style="max-height: 450px;"></canvas>
            <div id="stockout-insights" class="mt-3" style="display: none;">
                <div class="alert alert-warning">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Stockout Impact Insights</h6>
                    <div id="stockout-insights-content"></div>
                </div>
            </div>
        </div>

        <!-- Warehouse Comparison -->
        <div class="section-header">
            <h2 class="section-title">Warehouse Performance Comparison</h2>
            <p class="section-subtitle">Burnaby vs Kentucky sales performance</p>
        </div>

        <div class="warehouse-comparison" id="warehouse-comparison">
            <div class="warehouse-card">
                <h3 class="warehouse-title">
                    <i class="fas fa-warehouse me-2 text-primary"></i>
                    Burnaby (CA)
                </h3>
                <div id="burnaby-metrics">
                    <div class="metric-row">
                        <span class="metric-label">Revenue:</span>
                        <span class="metric-value" id="burnaby-revenue">$0</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Units Sold:</span>
                        <span class="metric-value" id="burnaby-units">0</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Avg Selling Price:</span>
                        <span class="metric-value" id="burnaby-asp">$0</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">SKU Count:</span>
                        <span class="metric-value" id="burnaby-skus">0</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Exclusive SKUs:</span>
                        <span class="metric-value" id="burnaby-exclusive">0</span>
                    </div>
                </div>
            </div>

            <div class="warehouse-card">
                <h3 class="warehouse-title">
                    <i class="fas fa-warehouse me-2 text-success"></i>
                    Kentucky (US)
                </h3>
                <div id="kentucky-metrics">
                    <div class="metric-row">
                        <span class="metric-label">Revenue:</span>
                        <span class="metric-value" id="kentucky-revenue">$0</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Units Sold:</span>
                        <span class="metric-value" id="kentucky-units">0</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Avg Selling Price:</span>
                        <span class="metric-value" id="kentucky-asp">$0</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">SKU Count:</span>
                        <span class="metric-value" id="kentucky-skus">0</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Exclusive SKUs:</span>
                        <span class="metric-value" id="kentucky-exclusive">0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Performers Table -->
        <div class="section-header">
            <h2 class="section-title">Top Performing SKUs</h2>
            <p class="section-subtitle">Highest revenue generating products</p>
        </div>

        <div class="table-container">
            <div class="loading-spinner" id="performers-loading">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
            <table id="performersTable" class="table table-striped table-hover" style="width:100%">
                <thead class="table-dark">
                    <tr>
                        <th>SKU</th>
                        <th>Description</th>
                        <th>Category</th>
                        <th>ABC</th>
                        <th>XYZ</th>
                        <th>Total Revenue</th>
                        <th>Total Units</th>
                        <th>Avg Price</th>
                        <th>Active Months</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- ABC-XYZ Matrix -->
        <div class="section-header">
            <h2 class="section-title">ABC-XYZ Classification Matrix</h2>
            <p class="section-subtitle">SKU distribution by revenue importance and demand volatility</p>
            <button class="btn btn-sm btn-outline-info ms-2" data-bs-toggle="collapse" data-bs-target="#abcXyzEducation" aria-expanded="false">
                <i class="fas fa-question-circle"></i> Learn More
            </button>
        </div>

        <!-- Educational Content Panel -->
        <div class="collapse mb-3" id="abcXyzEducation">
            <div class="card border-info">
                <div class="card-body">
                    <h5 class="card-title text-info">Understanding ABC-XYZ Classification</h5>

                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="fw-bold text-primary">ABC Classification (Revenue Importance)</h6>
                            <ul class="list-unstyled">
                                <li><strong>A-Class (80% of Revenue):</strong> High-value items that generate most of your revenue. These require priority attention and tight inventory control.</li>
                                <li><strong>B-Class (15% of Revenue):</strong> Medium-value items with moderate revenue contribution. Standard inventory management practices apply.</li>
                                <li><strong>C-Class (5% of Revenue):</strong> Low-value items with minimal revenue impact. Can tolerate higher stockout risk to reduce carrying costs.</li>
                            </ul>
                        </div>

                        <div class="col-md-6">
                            <h6 class="fw-bold text-success">XYZ Classification (Demand Variability)</h6>
                            <ul class="list-unstyled">
                                <li><strong>X-Class (Stable):</strong> Predictable demand patterns, easy to forecast. Low safety stock requirements.</li>
                                <li><strong>Y-Class (Moderate):</strong> Some demand fluctuation but manageable. Moderate safety stock and monitoring needed.</li>
                                <li><strong>Z-Class (Volatile):</strong> Highly unpredictable demand. Requires higher safety stock and frequent review.</li>
                            </ul>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-12">
                            <h6 class="fw-bold text-warning">Strategic Recommendations by Category</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="bg-light p-2 rounded mb-2">
                                        <strong>AX (High Value + Stable):</strong> Premium items with predictable demand. Implement just-in-time ordering with tight monitoring.
                                    </div>
                                    <div class="bg-light p-2 rounded mb-2">
                                        <strong>AY (High Value + Moderate):</strong> Important items with some variability. Use statistical forecasting and maintain safety stock.
                                    </div>
                                    <div class="bg-light p-2 rounded mb-2">
                                        <strong>AZ (High Value + Volatile):</strong> Critical but unpredictable. Requires close supplier relationships and buffer inventory.
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <div class="bg-light p-2 rounded mb-2">
                                        <strong>BX (Medium Value + Stable):</strong> Reliable workhorses. Standard EOQ calculations and regular reviews work well.
                                    </div>
                                    <div class="bg-light p-2 rounded mb-2">
                                        <strong>BY (Medium Value + Moderate):</strong> Average performers. Apply standard inventory management practices.
                                    </div>
                                    <div class="bg-light p-2 rounded mb-2">
                                        <strong>BZ (Medium Value + Volatile):</strong> Requires some extra attention. Monitor trends and adjust safety stock as needed.
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <div class="bg-light p-2 rounded mb-2">
                                        <strong>CX (Low Value + Stable):</strong> Low-priority items with predictable demand. Bulk ordering to minimize handling costs.
                                    </div>
                                    <div class="bg-light p-2 rounded mb-2">
                                        <strong>CY (Low Value + Moderate):</strong> Basic items. Simple min/max systems usually sufficient.
                                    </div>
                                    <div class="bg-light p-2 rounded mb-2">
                                        <strong>CZ (Low Value + Volatile):</strong> Consider discontinuation if margins are poor. Accept higher stockout risk.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="abcXyzChart" style="max-height: 400px;"></canvas>
        </div>

        <!-- All SKUs Section -->
        <div class="section-header">
            <h2 class="section-title">All SKUs Performance</h2>
            <p class="section-subtitle">Comprehensive listing of all SKUs with performance metrics and filters</p>
        </div>

        <div class="filter-card mb-3">
            <div class="row align-items-center">
                <div class="col-md-2">
                    <label for="abcFilterAll" class="form-label">ABC Class</label>
                    <select id="abcFilterAll" class="form-select">
                        <option value="">All Classes</option>
                        <option value="A">A - High Revenue</option>
                        <option value="B">B - Medium Revenue</option>
                        <option value="C">C - Low Revenue</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="xyzFilterAll" class="form-label">XYZ Class</label>
                    <select id="xyzFilterAll" class="form-select">
                        <option value="">All Classes</option>
                        <option value="X">X - Stable Demand</option>
                        <option value="Y">Y - Variable Demand</option>
                        <option value="Z">Z - Erratic Demand</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="minRevenue" class="form-label">Min Revenue</label>
                    <input type="number" id="minRevenue" class="form-control" placeholder="$0" min="0" step="100">
                </div>
                <div class="col-md-2">
                    <label for="sortBy" class="form-label">Sort By</label>
                    <select id="sortBy" class="form-select">
                        <option value="total_revenue_12m">Total Revenue</option>
                        <option value="total_units_12m">Total Units</option>
                        <option value="growth_rate_6m">Growth Rate</option>
                        <option value="avg_selling_price">Avg Price</option>
                        <option value="estimated_lost_sales">Lost Sales</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="sortOrder" class="form-label">Order</label>
                    <select id="sortOrder" class="form-select">
                        <option value="desc">Descending</option>
                        <option value="asc">Ascending</option>
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button id="applyFilters" class="btn btn-primary">
                        <i class="fas fa-filter me-1"></i>
                        Apply
                    </button>
                </div>
            </div>
        </div>

        <div class="table-container">
            <div class="loading-spinner" id="all-skus-loading">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
            <table id="allSkusTable" class="table table-striped table-hover" style="width:100%">
                <thead class="table-dark">
                    <tr>
                        <th>SKU</th>
                        <th>Description</th>
                        <th>Category</th>
                        <th>ABC</th>
                        <th>XYZ</th>
                        <th>12M Revenue</th>
                        <th>12M Units</th>
                        <th>Avg Price</th>
                        <th>Growth Rate</th>
                        <th>Lost Sales</th>
                        <th>Current KY</th>
                        <th>Current CA</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

            <!-- Pagination info -->
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div id="pagination-info">
                    Showing 0 of 0 SKUs
                </div>
                <div id="pagination-controls">
                    <button id="prevPage" class="btn btn-outline-primary btn-sm me-2" disabled>
                        <i class="fas fa-chevron-left"></i> Previous
                    </button>
                    <span id="pageInfo">Page 1 of 1</span>
                    <button id="nextPage" class="btn btn-outline-primary btn-sm ms-2" disabled>
                        Next <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Error Messages -->
        <div id="error-message" class="error-message">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span id="error-text">An error occurred loading the data.</span>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>

    <!-- Sales Dashboard JavaScript -->
    <script>
        /**
         * Sales Analytics Dashboard - Main Controller Class
         *
         * Manages all dashboard functionality including:
         * - Data loading and API communication
         * - Chart rendering and visualization
         * - User interaction and event handling
         * - Error handling and loading states
         * - Tooltip management and user guidance
         *
         * This class integrates with multiple backend APIs to provide
         * comprehensive sales analytics and insights.
         */
        class SalesDashboard {
            /**
             * Initialize the Sales Dashboard with default settings
             *
             * Sets up all necessary instance variables:
             * - Chart storage for Chart.js instances
             * - DataTable references for table management
             * - Loading state tracking
             * - Filter state management
             * - Error handling infrastructure
             * - Connection monitoring
             */
            constructor() {
                // Chart.js instances storage
                this.charts = {};

                // DataTables instances
                this.dataTable = null;
                this.allSkusTable = null;
                this.allSkusOffset = 0;
                this.allSkusPagination = null;

                // Loading state management
                this.loadingTasks = new Set();

                // Dashboard filter state
                this.currentFilters = {
                    monthsBack: 12,      // Analysis period in months
                    warehouse: null,     // Warehouse filter ('burnaby', 'kentucky', or null)
                    metric: 'revenue'    // Performance ranking metric
                };

                // Analytics data caches
                this.seasonalData = null;
                this.selectedSku = null;
                this.stockoutData = null;

                // Error handling infrastructure
                this.errorBoundaries = new Map();  // Maps context to retry functions
                this.retryAttempts = new Map();     // Tracks retry counts per operation
                this.connectionStatus = 'online';   // Network connectivity status

                // Initialize the dashboard
                this.init();
            }

            async init() {
                this.setupEventListeners();
                await this.loadDashboard();
            }

            setupEventListeners() {
                // Filter change handlers
                $('#monthsBack').on('change', (e) => {
                    this.currentFilters.monthsBack = parseInt(e.target.value);
                    this.loadDashboard();
                });

                $('#warehouseFilter').on('change', (e) => {
                    this.currentFilters.warehouse = e.target.value || null;
                    this.loadDashboard();
                });

                $('#performanceMetric').on('change', (e) => {
                    this.currentFilters.metric = e.target.value;
                    this.loadTopPerformers();
                });

                // Action buttons
                $('#refreshBtn').on('click', () => this.loadDashboard());
                $('#exportBtn').on('click', () => this.exportData());

                // All SKUs event handlers
                this.setupAllSkusEventHandlers();

                // Seasonal analysis event handlers
                this.setupSeasonalEventHandlers();

                // Stockout Pareto event handlers
                this.setupStockoutEventHandlers();

                // Auto-refresh every 5 minutes
                setInterval(() => this.loadDashboard(), 5 * 60 * 1000);

                // Initialize tooltips and error handling
                this.initializeTooltips();
                this.setupErrorHandling();
                this.monitorConnection();
            }

            async loadDashboard() {
                try {
                    this.showLoading();

                    // Load all dashboard components
                    await Promise.all([
                        this.loadSummary(),
                        this.loadRevenueTrends(),
                        this.loadSeasonalOptions(),
                        this.loadStockoutPareto(),
                        this.loadWarehouseComparison(),
                        this.loadTopPerformers(),
                        this.loadAbcXyzMatrix(),
                        this.loadAllSkus()
                    ]);

                    this.updateLastUpdated();
                    this.hideError();
                } catch (error) {
                    console.error('Error loading dashboard:', error);
                    this.showError('Failed to load dashboard data');
                } finally {
                    this.hideLoading();
                }
            }

            async loadSummary() {
                const context = 'Loading summary metrics';
                this.showLoadingOverlay('kpi-container', 'Loading summary metrics...');
                try {
                    this.updateProgress('kpi-container', 50, 'Fetching sales data...');
                    const response = await fetch(`/api/sales/summary?months_back=${this.currentFilters.monthsBack}`);

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const result = await response.json();

                    if (result.success) {
                        const data = result.data;

                        // Reset retry counter on success
                        this.retryAttempts.delete(context);

                        // Update KPI cards
                        $('#total-revenue').text(this.formatCurrency(data.total_revenue));
                        $('#avg-monthly').text(this.formatCurrency(data.average_monthly_revenue));
                        $('#stockout-loss').text(this.formatCurrency(data.estimated_stockout_loss));
                        $('#period-months').text(data.period_analyzed_months);

                        // Update growth indicator
                        const growth = data.monthly_growth_rate;
                        const trendElement = $('#revenue-trend');
                        if (growth > 0) {
                            trendElement.html(`<i class="fas fa-arrow-up trend-positive"></i> +${growth.toFixed(1)}%`);
                        } else if (growth < 0) {
                            trendElement.html(`<i class="fas fa-arrow-down trend-negative"></i> ${growth.toFixed(1)}%`);
                        } else {
                            trendElement.html(`<i class="fas fa-minus text-muted"></i> 0%`);
                        }
                    } else {
                        throw new Error(result.message || 'Failed to load summary data');
                    }
                } catch (error) {
                    this.handleApiError(error, context, () => this.loadSummary());
                } finally {
                    this.hideLoadingOverlay('kpi-container');
                }
            }

            async loadRevenueTrends() {
                const context = 'Loading revenue trends';
                try {
                    $('#trends-loading').show();
                    const response = await fetch(
                        `/api/sales/revenue-trends?months_back=${this.currentFilters.monthsBack}${
                            this.currentFilters.warehouse ? `&warehouse=${this.currentFilters.warehouse}` : ''
                        }`
                    );

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const result = await response.json();

                    if (result.success && result.data.monthly_trends) {
                        this.retryAttempts.delete(context);
                        this.renderRevenueTrendsChart(result.data.monthly_trends);
                    } else {
                        throw new Error(result.message || 'No trend data available');
                    }
                } catch (error) {
                    this.handleApiError(error, context, () => this.loadRevenueTrends());
                } finally {
                    $('#trends-loading').hide();
                }
            }

            async loadWarehouseComparison() {
                const context = 'Loading warehouse metrics';
                this.showLoadingOverlay('warehouse-comparison', 'Loading warehouse metrics...');
                try {
                    this.updateProgress('warehouse-comparison', 50, 'Comparing warehouse data...');
                    const response = await fetch(`/api/sales/warehouse-comparison?months_back=${this.currentFilters.monthsBack}`);

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const result = await response.json();

                    if (result.success) {
                        this.retryAttempts.delete(context);
                        const data = result.data;

                        // Update Burnaby metrics
                        if (data.burnaby) {
                            $('#burnaby-revenue').text(this.formatCurrency(data.burnaby.revenue));
                            $('#burnaby-units').text(this.formatNumber(data.burnaby.units));
                            $('#burnaby-asp').text(this.formatCurrency(data.burnaby.avg_selling_price));
                            $('#burnaby-skus').text(data.burnaby.sku_count);
                            $('#burnaby-exclusive').text(data.burnaby.exclusive_skus);
                        }

                        // Update Kentucky metrics
                        if (data.kentucky) {
                            $('#kentucky-revenue').text(this.formatCurrency(data.kentucky.revenue));
                            $('#kentucky-units').text(this.formatNumber(data.kentucky.units));
                            $('#kentucky-asp').text(this.formatCurrency(data.kentucky.avg_selling_price));
                            $('#kentucky-skus').text(data.kentucky.sku_count);
                            $('#kentucky-exclusive').text(data.kentucky.exclusive_skus);
                        }
                    } else {
                        throw new Error(result.message || 'Failed to load warehouse comparison data');
                    }
                } catch (error) {
                    this.handleApiError(error, context, () => this.loadWarehouseComparison());
                } finally {
                    this.hideLoadingOverlay('warehouse-comparison');
                }
            }

            async loadTopPerformers() {
                const context = 'Loading top performers';
                try {
                    $('#performers-loading').show();
                    const response = await fetch(
                        `/api/sales/top-performers?limit=50&metric=${this.currentFilters.metric}&period_months=${this.currentFilters.monthsBack}`
                    );

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const result = await response.json();

                    if (result.success) {
                        this.retryAttempts.delete(context);
                        this.renderPerformersTable(result.data);
                    } else {
                        throw new Error(result.message || 'No performer data available');
                    }
                } catch (error) {
                    this.handleApiError(error, context, () => this.loadTopPerformers());
                } finally {
                    $('#performers-loading').hide();
                }
            }

            async loadAbcXyzMatrix() {
                const response = await fetch('/api/sales/abc-xyz-matrix');
                const result = await response.json();

                if (result.success) {
                    this.renderAbcXyzChart(result.data);
                }
            }

            /**
             * Render the revenue trends chart using Chart.js
             *
             * Creates a combination bar/line chart showing:
             * - Monthly revenue as bars (left Y-axis)
             * - Units sold as line (right Y-axis)
             *
             * @param {Array} data - Array of monthly trend objects with revenue and units
             */
            renderRevenueTrendsChart(data) {
                const ctx = document.getElementById('revenueTrendsChart');

                // Clean up existing chart instance
                if (this.charts.revenue) {
                    this.charts.revenue.destroy();
                }

                const labels = data.map(row => row.year_month);
                const revenues = data.map(row => row.total_revenue);
                const units = data.map(row => row.total_units);

                this.charts.revenue = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Revenue ($)',
                            data: revenues,
                            backgroundColor: 'rgba(37, 99, 235, 0.7)',
                            borderColor: 'rgb(37, 99, 235)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        }, {
                            label: 'Units Sold',
                            data: units,
                            type: 'line',
                            borderColor: 'rgb(5, 150, 105)',
                            backgroundColor: 'rgba(5, 150, 105, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }]
                    },
                    options: {
                        responsive: true,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        scales: {
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Month'
                                }
                            },
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Revenue ($)'
                                },
                                ticks: {
                                    callback: value => this.formatCurrency(value)
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Units'
                                },
                                grid: {
                                    drawOnChartArea: false
                                },
                                ticks: {
                                    callback: value => this.formatNumber(value)
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        if (context.dataset.label === 'Revenue ($)') {
                                            return `Revenue: ${this.formatCurrency(context.raw)}`;
                                        } else {
                                            return `Units: ${this.formatNumber(context.raw)}`;
                                        }
                                    }
                                }
                            }
                        }
                    }
                });
            }

            renderPerformersTable(data) {
                if (this.dataTable) {
                    this.dataTable.destroy();
                }

                const tableData = data.map(row => [
                    row.sku_id,
                    row.description,
                    row.category || 'N/A',
                    `<span class="badge abc-badge-${row.abc_code}">${row.abc_code}</span>`,
                    `<span class="badge xyz-badge-${row.xyz_code}">${row.xyz_code}</span>`,
                    this.formatCurrency(row.total_revenue),
                    this.formatNumber(row.total_units),
                    this.formatCurrency(row.avg_selling_price),
                    row.months_with_sales,
                    `<button class="btn btn-sm btn-outline-primary" onclick="window.open('/static/sku-analysis.html?sku=${row.sku_id}', '_blank')">
                        <i class="fas fa-search"></i> Analyze
                    </button>`
                ]);

                this.dataTable = $('#performersTable').DataTable({
                    data: tableData,
                    pageLength: 25,
                    order: [[5, 'desc']], // Sort by revenue
                    dom: 'Bfrtip',
                    buttons: ['copy', 'csv', 'excel'],
                    columnDefs: [
                        { className: 'text-center', targets: [3, 4, 8, 9] },
                        { className: 'text-end', targets: [5, 6, 7] }
                    ]
                });
            }

            renderAbcXyzChart(data) {
                if (!data || data.length === 0) return;

                const ctx = document.getElementById('abcXyzChart');

                if (this.charts.matrix) {
                    this.charts.matrix.destroy();
                }

                // Prepare data for ABC-XYZ matrix visualization
                const labels = [];
                const revenues = [];
                const skuCounts = [];
                const colors = [];

                const colorMap = {
                    'A': 'rgba(5, 150, 105, 0.8)', // Green for A
                    'B': 'rgba(217, 119, 6, 0.8)', // Orange for B
                    'C': 'rgba(107, 114, 128, 0.8)' // Gray for C
                };

                // Process flat array of classification data
                data.forEach(classification => {
                    labels.push(classification.classification); // Already formatted as 'AX', 'BY', etc.
                    revenues.push(classification.total_revenue || 0);
                    skuCounts.push(classification.sku_count || 0);
                    colors.push(colorMap[classification.abc_code] || 'rgba(107, 114, 128, 0.8)');
                });

                this.charts.matrix = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Revenue by Classification',
                            data: revenues,
                            backgroundColor: colors,
                            borderColor: colors.map(c => c.replace('0.8', '1')),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'ABC-XYZ Revenue Distribution'
                            },
                            tooltip: {
                                callbacks: {
                                    afterLabel: (context) => {
                                        const index = context.dataIndex;
                                        const label = labels[index];
                                        const recommendations = this.getABCXYZRecommendations(label);
                                        return [
                                            `SKUs: ${skuCounts[index]}`,
                                            '',
                                            'Strategy:',
                                            ...recommendations
                                        ];
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Revenue ($)'
                                },
                                ticks: {
                                    callback: value => this.formatCurrency(value)
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Classification (ABC = Revenue, XYZ = Volatility)'
                                }
                            }
                        }
                    }
                });
            }

            async loadAllSkus() {
                const filters = {
                    limit: 100,
                    offset: this.allSkusOffset || 0,
                    abc_filter: $('#abcFilterAll').val() || null,
                    xyz_filter: $('#xyzFilterAll').val() || null,
                    min_revenue: parseFloat($('#minRevenue').val()) || null,
                    sort_by: $('#sortBy').val() || 'total_revenue_12m',
                    sort_order: $('#sortOrder').val() || 'desc'
                };

                const params = new URLSearchParams();
                Object.keys(filters).forEach(key => {
                    if (filters[key] !== null && filters[key] !== undefined) {
                        params.append(key, filters[key]);
                    }
                });

                try {
                    $('#all-skus-loading').show();
                    const response = await fetch(`/api/sales/all-skus?${params.toString()}`);
                    const result = await response.json();

                    if (result.success) {
                        this.renderAllSkusTable(result.data, result.pagination);
                    } else {
                        this.showError('Failed to load SKU data');
                    }
                } catch (error) {
                    console.error('Error loading all SKUs:', error);
                    this.showError('Failed to load SKU data');
                } finally {
                    $('#all-skus-loading').hide();
                }
            }

            renderAllSkusTable(data, pagination) {
                if (this.allSkusTable) {
                    this.allSkusTable.destroy();
                }

                const tableData = data.map(row => [
                    row.sku_id,
                    row.description || 'N/A',
                    row.category || 'N/A',
                    `<span class="badge abc-badge-${row.abc_code || 'N'}">${row.abc_code || 'N/A'}</span>`,
                    `<span class="badge xyz-badge-${row.xyz_code || 'N'}">${row.xyz_code || 'N/A'}</span>`,
                    this.formatCurrency(row.total_revenue_12m || 0),
                    this.formatNumber(row.total_units_12m || 0),
                    this.formatCurrency(row.avg_selling_price || 0),
                    this.formatPercentage(row.growth_rate_6m || 0),
                    this.formatNumber(row.estimated_lost_sales || 0),
                    this.formatNumber(row.current_ky_qty || 0),
                    this.formatNumber(row.current_ca_qty || 0),
                    `<button class="btn btn-sm btn-outline-primary" onclick="window.open('/static/sku-analysis.html?sku=${row.sku_id}', '_blank')">
                        <i class="fas fa-search"></i> Analyze
                    </button>`
                ]);

                this.allSkusTable = $('#allSkusTable').DataTable({
                    data: tableData,
                    paging: false, // We handle pagination manually
                    searching: false, // We handle filtering manually
                    ordering: false, // We handle sorting manually
                    info: false, // We show custom pagination info
                    scrollX: true,
                    language: {
                        emptyTable: "No SKUs found matching the current filters"
                    }
                });

                // Update pagination info
                this.updatePaginationInfo(pagination);
            }

            updatePaginationInfo(pagination) {
                const start = pagination.offset + 1;
                const end = Math.min(pagination.offset + pagination.limit, pagination.total);
                $('#pagination-info').text(`Showing ${start}-${end} of ${pagination.total} SKUs`);

                const currentPage = Math.floor(pagination.offset / pagination.limit) + 1;
                const totalPages = Math.ceil(pagination.total / pagination.limit);
                $('#pageInfo').text(`Page ${currentPage} of ${totalPages}`);

                // Enable/disable pagination buttons
                $('#prevPage').prop('disabled', pagination.offset === 0);
                $('#nextPage').prop('disabled', !pagination.has_more);

                // Store pagination state
                this.allSkusPagination = pagination;
            }

            setupAllSkusEventHandlers() {
                $('#applyFilters').on('click', () => {
                    this.allSkusOffset = 0; // Reset to first page when filters change
                    this.loadAllSkus();
                });

                $('#prevPage').on('click', () => {
                    if (this.allSkusOffset > 0) {
                        this.allSkusOffset = Math.max(0, this.allSkusOffset - 100);
                        this.loadAllSkus();
                    }
                });

                $('#nextPage').on('click', () => {
                    if (this.allSkusPagination && this.allSkusPagination.has_more) {
                        this.allSkusOffset = this.allSkusOffset + 100;
                        this.loadAllSkus();
                    }
                });
            }

            setupSeasonalEventHandlers() {
                $('#loadSeasonalBtn').on('click', () => {
                    this.loadSeasonalAnalysis();
                });

                $('#seasonalSku').on('change', (e) => {
                    this.selectedSku = e.target.value || null;
                });
            }

            async loadSeasonalOptions() {
                try {
                    // Get all active SKUs for seasonal analysis dropdown
                    const response = await fetch('/api/sales/active-skus');
                    const result = await response.json();

                    if (result.success && result.data) {
                        const select = $('#seasonalSku');
                        select.empty().append('<option value="">Overall Sales Pattern</option>');

                        // Show all active SKUs (950) instead of just top 20
                        result.data.forEach(sku => {
                            select.append(`<option value="${sku.sku_id}">${sku.sku_id} - ${sku.description}</option>`);
                        });

                        console.log(`Loaded ${result.data.length} active SKUs for seasonal analysis`);
                    }
                } catch (error) {
                    console.error('Error loading seasonal options:', error);
                }
            }

            async loadSeasonalAnalysis() {
                try {
                    $('#seasonal-loading').show();
                    $('#seasonal-insights').hide();

                    const monthsBack = $('#seasonalPeriod').val() || 24;
                    const skuId = this.selectedSku;

                    let url = `/api/sales/seasonal-analysis?months_back=${monthsBack}&min_months_required=18`;
                    if (skuId) {
                        url += `&sku_id=${encodeURIComponent(skuId)}`;
                    }
                    if (this.currentFilters.warehouse) {
                        url += `&warehouse=${this.currentFilters.warehouse}`;
                    }

                    const response = await fetch(url);
                    const result = await response.json();

                    if (result.success && result.data && result.data.length > 0) {
                        const seasonalData = result.data[0]; // Get first item from array
                        this.renderSeasonalChart(seasonalData);
                        this.showSeasonalInsights(seasonalData);
                    } else {
                        this.showError('Failed to load seasonal analysis: ' + (result.message || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error loading seasonal analysis:', error);
                    this.showError('Failed to load seasonal analysis');
                } finally {
                    $('#seasonal-loading').hide();
                }
            }

            /**
             * Render seasonal analysis chart with confidence bands
             *
             * Displays seasonal factors by month with:
             * - Main line showing seasonal multipliers (1.0 = average)
             * - Confidence bands showing statistical uncertainty
             * - Peak/low season identification
             *
             * @param {Object} data - Seasonal analysis data including factors and confidence
             */
            renderSeasonalChart(data) {
                const ctx = document.getElementById('seasonalChart');

                // Clean up existing chart instance
                if (this.charts.seasonal) {
                    this.charts.seasonal.destroy();
                }

                if (!data.has_seasonal_pattern || !data.seasonal_factors) {
                    // Show message for no seasonal pattern
                    ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
                    const context = ctx.getContext('2d');
                    context.font = '16px Arial';
                    context.textAlign = 'center';
                    context.fillText('No significant seasonal pattern detected', ctx.width / 2, ctx.height / 2);
                    return;
                }

                // Prepare data for seasonal factors chart
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const factors = new Array(12).fill(1.0);
                const confidenceBands = {
                    upper: new Array(12).fill(1.0),
                    lower: new Array(12).fill(1.0)
                };

                // Map seasonal factors to months (seasonal_factors is an object with month keys)
                Object.entries(data.seasonal_factors).forEach(([month, factor]) => {
                    const monthIndex = parseInt(month) - 1; // Convert 1-12 to 0-11
                    if (monthIndex >= 0 && monthIndex < 12) {
                        factors[monthIndex] = factor;
                        // Get confidence from factor_confidence if available
                        const confidence = data.factor_confidence ? data.factor_confidence[month] : factor;
                        confidenceBands.upper[monthIndex] = confidence * 1.1; // 10% confidence band
                        confidenceBands.lower[monthIndex] = confidence * 0.9;
                    }
                });

                this.charts.seasonal = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Seasonal Factor',
                            data: factors,
                            borderColor: 'rgb(37, 99, 235)',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.4,
                            pointRadius: 6,
                            pointHoverRadius: 8
                        }, {
                            label: 'Confidence Band (Upper)',
                            data: confidenceBands.upper,
                            borderColor: 'rgba(37, 99, 235, 0.3)',
                            backgroundColor: 'transparent',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        }, {
                            label: 'Confidence Band (Lower)',
                            data: confidenceBands.lower,
                            borderColor: 'rgba(37, 99, 235, 0.3)',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            fill: '-1', // Fill to previous dataset
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Month'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Seasonal Factor (1.0 = Average)'
                                },
                                beginAtZero: false,
                                ticks: {
                                    callback: (value) => value.toFixed(2)
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: data.sku_id ? `Seasonal Pattern: ${data.sku_id}` : 'Overall Seasonal Pattern'
                            },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const factor = context.parsed.y;
                                        const percentage = ((factor - 1) * 100).toFixed(1);
                                        return `${context.dataset.label}: ${factor.toFixed(3)} (${percentage > 0 ? '+' : ''}${percentage}%)`;
                                    }
                                }
                            },
                            legend: {
                                display: true,
                                labels: {
                                    filter: (legendItem) => legendItem.text === 'Seasonal Factor' // Only show main line in legend
                                }
                            }
                        }
                    }
                });
            }

            showSeasonalInsights(data) {
                const insights = [];

                if (data.has_seasonal_pattern) {
                    const confidenceLevel = data.statistical_significance?.confidence_level || data.pattern_strength || 0;
                    insights.push(`<strong>Seasonal Pattern Detected:</strong> Statistical significance level ${(confidenceLevel * 100).toFixed(1)}%`);

                    if (data.peak_months && data.peak_months.length > 0) {
                        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                        const peakNames = data.peak_months.map(m => monthNames[m - 1]).join(', ');
                        insights.push(`<strong>Peak Season:</strong> ${peakNames}`);
                    }

                    if (data.low_months && data.low_months.length > 0) {
                        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                        const lowNames = data.low_months.map(m => monthNames[m - 1]).join(', ');
                        insights.push(`<strong>Low Season:</strong> ${lowNames}`);
                    }

                    if (data.seasonal_strength !== undefined) {
                        insights.push(`<strong>Seasonal Strength:</strong> ${(data.seasonal_strength * 100).toFixed(1)}% variation from average`);
                    }

                    if (data.business_insights && data.business_insights.length > 0) {
                        insights.push('<strong>Recommendations:</strong>');
                        data.business_insights.forEach(insight => {
                            insights.push(`• ${insight}`);
                        });
                    }
                } else {
                    insights.push('<strong>No Significant Seasonal Pattern:</strong> Sales are relatively stable throughout the year.');
                    insights.push('• Consider consistent inventory levels across all months');
                    insights.push('• Focus on other demand drivers like promotions or trends');
                }

                if (insights.length > 0) {
                    $('#seasonal-insights-content').html(insights.join('<br>'));
                    $('#seasonal-insights').show();

                    // Show business insights panel with actionable recommendations
                    this.showSeasonalBusinessInsights(data);
                } else {
                    $('#seasonal-business-insights').hide();
                }
            }

            /**
             * Display business insights and recommendations for seasonal patterns
             *
             * @param {Object} data - Seasonal analysis data
             */
            showSeasonalBusinessInsights(data) {
                const recommendations = [];

                if (data.has_seasonal_pattern) {
                    // Peak season recommendations
                    if (data.peak_months && data.peak_months.length > 0) {
                        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                        const peakNames = data.peak_months.map(m => monthNames[m - 1]).join(', ');

                        recommendations.push({
                            type: 'success',
                            title: 'Pre-Peak Inventory Planning',
                            icon: 'fas fa-chart-line',
                            text: `Build inventory 1-2 months before peak season (${peakNames}). Consider increasing safety stock levels by 20-40% to handle demand spikes.`
                        });
                    }

                    // Low season recommendations
                    if (data.low_months && data.low_months.length > 0) {
                        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                        const lowNames = data.low_months.map(m => monthNames[m - 1]).join(', ');

                        recommendations.push({
                            type: 'warning',
                            title: 'Low Season Strategy',
                            icon: 'fas fa-calendar-times',
                            text: `Reduce inventory levels during ${lowNames}. Consider promotions or liquidation of excess stock. Plan maintenance activities during this period.`
                        });
                    }

                    // Seasonal strength insights
                    if (data.seasonal_strength > 0.3) {
                        recommendations.push({
                            type: 'info',
                            title: 'High Seasonality Impact',
                            icon: 'fas fa-exclamation-triangle',
                            text: 'Strong seasonal patterns detected. Implement seasonal forecasting models and adjust reorder points monthly to optimize inventory turns.'
                        });
                    }

                    recommendations.push({
                        type: 'primary',
                        title: 'Forecasting Recommendation',
                        icon: 'fas fa-crystal-ball',
                        text: 'Use these seasonal factors to multiply your base demand forecasts. Update safety stock calculations to account for seasonal variability.'
                    });

                } else {
                    recommendations.push({
                        type: 'info',
                        title: 'Stable Demand Pattern',
                        icon: 'fas fa-equals',
                        text: 'No significant seasonal patterns detected. Maintain consistent inventory levels and focus on other demand drivers like trends or promotions.'
                    });
                }

                // Render recommendations
                let html = '';
                recommendations.forEach(rec => {
                    html += `
                        <div class="col-md-6 mb-3">
                            <div class="alert alert-${rec.type} border-${rec.type}">
                                <h6 class="alert-heading"><i class="${rec.icon} me-2"></i>${rec.title}</h6>
                                <p class="mb-0 small">${rec.text}</p>
                            </div>
                        </div>
                    `;
                });

                $('#seasonal-recommendations').html(html);
                $('#seasonal-business-insights').show();
            }

            setupStockoutEventHandlers() {
                $('#loadStockoutBtn').on('click', () => {
                    this.loadStockoutPareto();
                });
            }

            async loadStockoutPareto() {
                try {
                    $('#stockout-loading').show();
                    $('#stockout-insights').hide();

                    const monthsBack = $('#stockoutPeriod').val() || 12;
                    const minImpact = parseFloat($('#minStockoutImpact').val()) || 100;

                    let url = `/api/sales/stockout-impact?months_back=${monthsBack}&min_impact=${minImpact}`;
                    if (this.currentFilters.warehouse) {
                        url += `&warehouse=${this.currentFilters.warehouse}`;
                    }

                    const response = await fetch(url);
                    const result = await response.json();

                    if (result.success && result.data) {
                        this.renderStockoutParetoChart(result.data);
                        this.showStockoutInsights(result.data);
                    } else {
                        this.showError('Failed to load stockout analysis: ' + (result.message || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error loading stockout analysis:', error);
                    this.showError('Failed to load stockout analysis');
                } finally {
                    $('#stockout-loading').hide();
                }
            }

            /**
             * Render stockout impact Pareto chart (80/20 analysis)
             *
             * Shows which SKUs contribute most to revenue losses:
             * - Individual SKU losses as red bars (left Y-axis)
             * - Cumulative percentage as orange line (right Y-axis)
             * - Identifies the vital few SKUs causing most impact
             *
             * @param {Object} data - Stockout analysis data with affected SKUs and totals
             */
            renderStockoutParetoChart(data) {
                const ctx = document.getElementById('stockoutParetoChart');

                // Clean up existing chart instance
                if (this.charts.stockout) {
                    this.charts.stockout.destroy();
                }

                if (!data.affected_skus || data.affected_skus.length === 0) {
                    // Show message for no stockout data
                    const context = ctx.getContext('2d');
                    context.clearRect(0, 0, ctx.width, ctx.height);
                    context.font = '16px Arial';
                    context.textAlign = 'center';
                    context.fillText('No significant stockout impact found in the selected period', ctx.width / 2, ctx.height / 2);
                    return;
                }

                // Sort SKUs by estimated lost revenue (descending)
                const sortedSkus = [...data.affected_skus].sort((a, b) => (b.estimated_lost_revenue || 0) - (a.estimated_lost_revenue || 0));

                // Take top 20 for readability
                const topSkus = sortedSkus.slice(0, 20);

                // Calculate cumulative percentages for Pareto analysis
                const totalLoss = data.total_estimated_loss || topSkus.reduce((sum, sku) => sum + (sku.estimated_lost_revenue || 0), 0);
                let cumulativeLoss = 0;
                const paretoData = topSkus.map(sku => {
                    cumulativeLoss += (sku.estimated_lost_revenue || 0);
                    return {
                        sku_id: sku.sku_id,
                        loss: sku.estimated_lost_revenue || 0,
                        cumulative_percentage: (cumulativeLoss / totalLoss) * 100
                    };
                });

                const labels = paretoData.map(item => item.sku_id);
                const lossAmounts = paretoData.map(item => item.loss);
                const cumulativePercentages = paretoData.map(item => item.cumulative_percentage);

                this.charts.stockout = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Estimated Lost Revenue',
                            data: lossAmounts,
                            backgroundColor: 'rgba(220, 38, 38, 0.7)',
                            borderColor: 'rgb(220, 38, 38)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        }, {
                            label: 'Cumulative %',
                            data: cumulativePercentages,
                            type: 'line',
                            borderColor: 'rgb(217, 119, 6)',
                            backgroundColor: 'rgba(217, 119, 6, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            yAxisID: 'y1'
                        }]
                    },
                    options: {
                        responsive: true,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'SKU (Top 20 by Lost Revenue)'
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            },
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Estimated Lost Revenue ($)'
                                },
                                ticks: {
                                    callback: value => this.formatCurrency(value)
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Cumulative Percentage (%)'
                                },
                                min: 0,
                                max: 100,
                                grid: {
                                    drawOnChartArea: false
                                },
                                ticks: {
                                    callback: value => value.toFixed(1) + '%'
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Stockout Impact Pareto Analysis (80/20 Rule)'
                            },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        if (context.dataset.label === 'Estimated Lost Revenue') {
                                            return `Lost Revenue: ${this.formatCurrency(context.raw)}`;
                                        } else {
                                            return `Cumulative: ${context.raw.toFixed(1)}%`;
                                        }
                                    }
                                }
                            },
                            legend: {
                                display: true
                            }
                        }
                    }
                });

                // Add 80% line annotation if available
                if (cumulativePercentages.length > 0) {
                    const eightyPercentIndex = cumulativePercentages.findIndex(p => p >= 80);
                    if (eightyPercentIndex >= 0) {
                        console.log(`80% of stockout impact comes from top ${eightyPercentIndex + 1} SKUs`);
                    }
                }
            }

            showStockoutInsights(data) {
                const insights = [];

                if (data.total_estimated_loss && data.total_estimated_loss > 0) {
                    insights.push(`<strong>Total Estimated Loss:</strong> ${this.formatCurrency(data.total_estimated_loss)} over ${data.period_months} months`);

                    if (data.affected_skus && data.affected_skus.length > 0) {
                        insights.push(`<strong>Affected SKUs:</strong> ${data.affected_skus.length} SKUs with stockout impact`);

                        // Calculate 80/20 insights
                        const sortedSkus = [...data.affected_skus].sort((a, b) => (b.estimated_lost_revenue || 0) - (a.estimated_lost_revenue || 0));
                        const totalLoss = data.total_estimated_loss;
                        let cumulativeLoss = 0;
                        let eightyPercentCount = 0;

                        for (let i = 0; i < sortedSkus.length; i++) {
                            cumulativeLoss += (sortedSkus[i].estimated_lost_revenue || 0);
                            if (cumulativeLoss / totalLoss >= 0.8) {
                                eightyPercentCount = i + 1;
                                break;
                            }
                        }

                        if (eightyPercentCount > 0) {
                            const percentage = ((eightyPercentCount / data.affected_skus.length) * 100).toFixed(1);
                            insights.push(`<strong>Pareto Insight:</strong> Top ${eightyPercentCount} SKUs (${percentage}%) account for 80% of stockout losses`);
                        }

                        // Top worst performers
                        const topWorst = sortedSkus.slice(0, 3);
                        const worstList = topWorst.map(sku =>
                            `${sku.sku_id} (${this.formatCurrency(sku.estimated_lost_revenue || 0)})`
                        ).join(', ');
                        insights.push(`<strong>Worst Performers:</strong> ${worstList}`);
                    }

                    if (data.business_insights && data.business_insights.length > 0) {
                        insights.push('<strong>Recommendations:</strong>');
                        data.business_insights.forEach(insight => {
                            insights.push(`• ${insight}`);
                        });
                    } else {
                        insights.push('<strong>Recommendations:</strong>');
                        insights.push('• Focus inventory management on the top-impact SKUs first');
                        insights.push('• Review safety stock levels for frequently stocked-out items');
                        insights.push('• Consider supplier lead time improvements for high-impact SKUs');
                    }
                } else {
                    insights.push('<strong>Good News:</strong> No significant stockout impact detected in the selected period.');
                    insights.push('• Current inventory management appears to be effective');
                    insights.push('• Continue monitoring for seasonal or demand spikes');
                }

                if (insights.length > 0) {
                    $('#stockout-insights-content').html(insights.join('<br>'));
                    $('#stockout-insights').show();
                }
            }

            formatPercentage(value) {
                if (!value) return '0%';
                const formatted = Math.round(value * 100) / 100;
                return `${formatted > 0 ? '+' : ''}${formatted.toFixed(1)}%`;
            }

            async exportData() {
                try {
                    const response = await fetch(
                        `/api/sales/export/summary?months_back=${this.currentFilters.monthsBack}&format=json`
                    );
                    const result = await response.json();

                    if (result.success) {
                        const dataStr = JSON.stringify(result.data, null, 2);
                        const dataBlob = new Blob([dataStr], {type: 'application/json'});

                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(dataBlob);
                        link.download = `sales-analytics-${new Date().toISOString().split('T')[0]}.json`;
                        link.click();
                    }
                } catch (error) {
                    console.error('Export failed:', error);
                    this.showError('Failed to export data');
                }
            }

            /**
             * Format numeric values as US currency
             *
             * @param {number} value - Numeric value to format
             * @returns {string} Formatted currency string (e.g., '$1,234')
             */
            formatCurrency(value) {
                if (!value) return '$0';
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(value);
            }

            /**
             * Format numeric values with thousands separators
             *
             * @param {number} value - Numeric value to format
             * @returns {string} Formatted number string (e.g., '1,234')
             */
            formatNumber(value) {
                if (!value) return '0';
                return new Intl.NumberFormat('en-US').format(value);
            }

            /**
             * Get strategic recommendations for ABC-XYZ classification combinations
             *
             * @param {string} classification - ABC-XYZ classification (e.g., 'AX', 'BY', 'CZ')
             * @returns {array} Array of recommendation strings for tooltip display
             */
            getABCXYZRecommendations(classification) {
                const recommendations = {
                    'AX': [
                        '• Premium items with predictable demand',
                        '• Implement just-in-time ordering',
                        '• Tight monitoring and forecasting',
                        '• High service level targets (98-99%)'
                    ],
                    'AY': [
                        '• Important items with moderate variability',
                        '• Use statistical forecasting models',
                        '• Maintain appropriate safety stock',
                        '• Service level targets (95-98%)'
                    ],
                    'AZ': [
                        '• Critical but unpredictable items',
                        '• Close supplier relationships essential',
                        '• Higher buffer inventory required',
                        '• Frequent demand review needed'
                    ],
                    'BX': [
                        '• Reliable workhorses with stable demand',
                        '• Standard EOQ calculations apply',
                        '• Regular periodic reviews sufficient',
                        '• Service level targets (90-95%)'
                    ],
                    'BY': [
                        '• Average performers, standard treatment',
                        '• Apply standard inventory practices',
                        '• Monitor for trend changes',
                        '• Service level targets (85-92%)'
                    ],
                    'BZ': [
                        '• Requires extra attention despite medium value',
                        '• Monitor trends and adjust safety stock',
                        '• Consider demand pattern analysis',
                        '• Flexible service levels (80-90%)'
                    ],
                    'CX': [
                        '• Low-priority items with predictable demand',
                        '• Bulk ordering to minimize handling costs',
                        '• Accept longer lead times',
                        '• Service level targets (75-85%)'
                    ],
                    'CY': [
                        '• Basic items with moderate demand variation',
                        '• Simple min/max systems usually sufficient',
                        '• Periodic bulk replenishment',
                        '• Service level targets (70-80%)'
                    ],
                    'CZ': [
                        '• Consider discontinuation if margins poor',
                        '• Accept higher stockout risk',
                        '• Minimal inventory investment',
                        '• Service level targets (60-75%)'
                    ]
                };

                return recommendations[classification] || [
                    '• Classification not recognized',
                    '• Review ABC-XYZ analysis settings'
                ];
            }

            updateLastUpdated() {
                const now = new Date();
                $('#last-updated').text(`Updated: ${now.toLocaleTimeString()}`);
            }

            showLoading() {
                $('.loading-spinner').show();
            }

            hideLoading() {
                $('.loading-spinner').hide();
            }

            showLoadingOverlay(containerId, task = 'Loading data...') {
                const container = $(`#${containerId}`);
                if (container.length === 0) return;

                // Remove existing overlay
                container.find('.loading-overlay').remove();

                const overlay = $(`
                    <div class="loading-overlay d-flex">
                        <div class="progress-container">
                            <div class="progress-spinner">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                            <div class="progress-text">${task}</div>
                            <div class="progress-bar-custom">
                                <div class="progress-fill"></div>
                            </div>
                        </div>
                    </div>
                `);

                container.append(overlay);
                overlay.show();

                // Animate progress bar
                setTimeout(() => {
                    overlay.find('.progress-fill').css('width', '30%');
                }, 100);

                this.loadingTasks.add(containerId);
            }

            hideLoadingOverlay(containerId) {
                const container = $(`#${containerId}`);
                if (container.length === 0) return;

                const overlay = container.find('.loading-overlay');
                if (overlay.length > 0) {
                    // Complete progress bar before hiding
                    overlay.find('.progress-fill').css('width', '100%');
                    setTimeout(() => {
                        overlay.fadeOut(300, () => overlay.remove());
                    }, 200);
                }

                this.loadingTasks.delete(containerId);
            }

            updateProgress(containerId, percentage, task) {
                const container = $(`#${containerId}`);
                const overlay = container.find('.loading-overlay');
                if (overlay.length > 0) {
                    overlay.find('.progress-fill').css('width', `${Math.max(30, percentage)}%`);
                    if (task) {
                        overlay.find('.progress-text').text(task);
                    }
                }
            }

            showSkeletonLoader(containerId) {
                const container = $(`#${containerId}`);
                if (container.length === 0) return;

                const skeleton = $(`
                    <div class="skeleton-card">
                        <div class="loading-skeleton skeleton-line medium"></div>
                        <div class="loading-skeleton skeleton-line long"></div>
                        <div class="loading-skeleton skeleton-line short"></div>
                        <div class="loading-skeleton skeleton-line long"></div>
                        <div class="loading-skeleton skeleton-line medium"></div>
                    </div>
                `);

                container.html(skeleton);
            }

            initializeTooltips() {
                // Add tooltips to various elements
                this.addTooltip('#total-revenue', 'Total revenue across all SKUs and warehouses for the selected period');
                this.addTooltip('#avg-monthly', 'Average monthly revenue calculated from the selected analysis period');
                this.addTooltip('#stockout-loss', 'Estimated revenue lost due to stockouts, calculated using demand correction factors');
                this.addTooltip('#period-months', 'Number of months included in the current analysis');

                // Filter tooltips
                this.addTooltip('label[for="monthsBack"]', 'Select the time period for analysis. Longer periods provide more stable trends but may include outdated patterns.');
                this.addTooltip('label[for="warehouseFilter"]', 'Filter data by specific warehouse. "Both" shows combined metrics across all locations.');
                this.addTooltip('label[for="performanceMetric"]', 'Choose the metric for ranking top performers: Revenue (total sales), Units (quantity sold), or Growth (percentage increase).');

                // Seasonal analysis tooltips
                this.addTooltip('label[for="seasonalSku"]', 'Select a specific SKU for detailed seasonal analysis, or choose "Overall" for aggregate patterns.');
                this.addTooltip('label[for="seasonalPeriod"]', 'Minimum 18 months of data required for reliable seasonal pattern detection.');

                // Stockout analysis tooltips
                this.addTooltip('label[for="stockoutPeriod"]', 'Time period for stockout impact analysis. Longer periods show more comprehensive patterns.');
                this.addTooltip('label[for="minStockoutImpact"]', 'Minimum dollar amount of estimated lost revenue to include SKUs in the analysis.');

                // Classification tooltips
                this.addTooltip('.abc-badge-A', 'Class A: High-value items contributing to top 80% of revenue', 'mouseenter');
                this.addTooltip('.abc-badge-B', 'Class B: Medium-value items contributing to next 15% of revenue', 'mouseenter');
                this.addTooltip('.abc-badge-C', 'Class C: Low-value items contributing to bottom 5% of revenue', 'mouseenter');
                this.addTooltip('.xyz-badge-X', 'Class X: Stable demand with low variability (CV < 0.5)', 'mouseenter');
                this.addTooltip('.xyz-badge-Y', 'Class Y: Variable demand with moderate predictability (CV 0.5-1.0)', 'mouseenter');
                this.addTooltip('.xyz-badge-Z', 'Class Z: Erratic demand with high variability (CV > 1.0)', 'mouseenter');
            }

            addTooltip(selector, text, trigger = 'hover') {
                const elements = $(selector);
                if (elements.length === 0) return;

                elements.each(function() {
                    const $element = $(this);
                    if ($element.data('tooltip-added')) return;

                    // Add tooltip icon if not already present
                    if (!$element.find('.tooltip-icon').length && !$element.hasClass('badge')) {
                        $element.append('<span class="tooltip-icon">?</span>');
                    }

                    const tooltip = $(`<div class="custom-tooltip">${text}</div>`);
                    $('body').append(tooltip);

                    const showTooltip = (e) => {
                        const rect = e.currentTarget.getBoundingClientRect();
                        tooltip.css({
                            left: rect.left + rect.width / 2,
                            top: rect.top - 35
                        }).addClass('show');
                    };

                    const hideTooltip = () => {
                        tooltip.removeClass('show');
                    };

                    if (trigger === 'hover') {
                        $element.on('mouseenter', showTooltip);
                        $element.on('mouseleave', hideTooltip);
                    } else if (trigger === 'mouseenter') {
                        $element.on('mouseenter', showTooltip);
                        $element.on('mouseleave', hideTooltip);
                    }

                    $element.data('tooltip-added', true);
                });
            }

            setupErrorHandling() {
                // Global error handler for unhandled promise rejections
                window.addEventListener('unhandledrejection', (event) => {
                    console.error('Unhandled promise rejection:', event.reason);
                    this.showError('An unexpected error occurred. Please try refreshing the page.');
                });

                // Network error detection
                window.addEventListener('offline', () => {
                    this.connectionStatus = 'offline';
                    this.showConnectionStatus('You are currently offline. Data may not be up to date.', 'offline');
                });

                window.addEventListener('online', () => {
                    this.connectionStatus = 'online';
                    this.showConnectionStatus('Connection restored. Refreshing data...', 'online');
                    setTimeout(() => {
                        this.loadDashboard();
                        this.hideConnectionStatus();
                    }, 2000);
                });
            }

            monitorConnection() {
                // Connection monitoring removed - not necessary for dashboard functionality
                // Dashboard works reliably without health checks
            }

            showConnectionStatus(message, type) {
                const status = $('.connection-status');
                if (status.length === 0) {
                    $('body').append(`<div class="connection-status ${type}">${message}</div>`);
                } else {
                    status.removeClass('online offline').addClass(type).text(message);
                }
                $('.connection-status').show();
            }

            hideConnectionStatus() {
                $('.connection-status').fadeOut();
            }

            /**
             * Handle API errors with intelligent retry logic
             *
             * Implements exponential backoff retry strategy:
             * - Up to 3 automatic retries with increasing delays (1s, 2s, 4s)
             * - After max retries, shows persistent error with manual retry option
             * - Tracks retry attempts per operation context
             *
             * @param {Error|string} error - The error that occurred
             * @param {string} context - Human-readable context (e.g., 'Loading summary metrics')
             * @param {Function} retryFunction - Function to call for retry attempts
             */
            handleApiError(error, context, retryFunction) {
                console.error(`Error in ${context}:`, error);

                const retryKey = context;
                const attempts = this.retryAttempts.get(retryKey) || 0;

                if (attempts < 3 && retryFunction) {
                    // Auto-retry up to 3 times with exponential backoff
                    const delay = Math.pow(2, attempts) * 1000; // 1s, 2s, 4s
                    this.retryAttempts.set(retryKey, attempts + 1);

                    setTimeout(() => {
                        console.log(`Retrying ${context} (attempt ${attempts + 1})`);
                        retryFunction();
                    }, delay);

                    this.showError(`${context} failed. Retrying in ${delay / 1000}s... (${attempts + 1}/3)`);
                } else {
                    // Show permanent error with retry option
                    this.showPersistentError(error, context, retryFunction);
                    this.retryAttempts.delete(retryKey);
                }
            }

            showPersistentError(error, context, retryFunction) {
                const errorId = `error-${Date.now()}`;
                let errorMessage = 'An unexpected error occurred';

                if (error.message) {
                    errorMessage = error.message;
                } else if (typeof error === 'string') {
                    errorMessage = error;
                }

                const errorHtml = `
                    <div class="error-boundary" id="${errorId}">
                        <div class="error-title">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            ${context} Failed
                        </div>
                        <div class="error-details">
                            ${errorMessage}
                        </div>
                        <div class="error-actions">
                            ${retryFunction ? `<button class="retry-btn" onclick="dashboard.retryOperation('${context}', '${errorId}')">Retry</button>` : ''}
                            <button class="dismiss-btn" onclick="$('#${errorId}').remove()">Dismiss</button>
                        </div>
                    </div>
                `;

                // Store retry function for later use
                if (retryFunction) {
                    this.errorBoundaries.set(context, retryFunction);
                }

                // Show error in appropriate location
                const container = this.getErrorContainer(context);
                container.prepend(errorHtml);
            }

            retryOperation(context, errorId) {
                const retryFunction = this.errorBoundaries.get(context);
                if (retryFunction) {
                    $(`#${errorId}`).remove();
                    this.retryAttempts.delete(context);
                    retryFunction();
                } else {
                    console.warn(`No retry function found for context: ${context}`);
                }
            }

            getErrorContainer(context) {
                // Determine where to show the error based on context
                switch (context) {
                    case 'Loading summary metrics':
                        return $('#kpi-container');
                    case 'Loading revenue trends':
                        return $('.chart-container:first');
                    case 'Loading warehouse metrics':
                        return $('#warehouse-comparison');
                    case 'Loading top performers':
                        return $('.table-container:first');
                    default:
                        return $('.container-fluid');
                }
            }

            showError(message) {
                $('#error-text').text(message);
                $('#error-message').show();
            }

            hideError() {
                $('#error-message').hide();
            }
        }

        // Initialize dashboard when page loads
        $(document).ready(() => {
            window.dashboard = new SalesDashboard();
        });
    </script>
</body>
</html>